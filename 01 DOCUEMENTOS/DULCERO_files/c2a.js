var _slContainerDivId="uploadControlContainer",_dlContainerDivId="dlUploadControlContainer",_dlAttachmentsDivId="dlAttachmentsContainer",_requiredVersion=ComposePage.uploadControlData.requiredSilverlightVersion,_isSilverlightSupportedBrowser=Silverlight.supportedUserAgent(_requiredVersion,null),_useSilverlightUpload=$(_slContainerDivId)&&_isSilverlightSupportedBrowser&&Silverlight.isInstalled(_requiredVersion),_silverlightUploader=null,_silverlightUploaderTimeoutId=null;$BSI.reportEvent("Compose.Messaging.Mail",{SLcontrol:_useSilverlightUpload?"1":"0"},true);if(!_useSilverlightUpload)AttachmentUpload$enableDownlevelInsertBar();function AttachmentUpload(a){Control.create(this,a);this._slUploadControl=null;if(_useSilverlightUpload)this._slUploadControl=this.createUploadControl($(_slContainerDivId),ComposePage.uploadControlData);this.Events={onuienabled:new $Event};this._ui=$tag(a,"div")[0];this._list=$tag(a,"UL")[0];this._attachIframe=$tag(a,"iframe")[0];this._form=$tag(a,"input")[0];this._total=$tag($tag(this._ui,"div")[0],"span")[0];this._box=$tag(this._ui,"div")[1];this._maybeResetAttachments();this._rehydrate();this._iframeLoadHandler=$CD(this,this._onUploadFinished);this._attachIframe.attachEvent("onload",this._iframeLoadHandler);this._attListResizeHandler=$CD(this,this._onResizeAttList);this._list.attachEvent("onresize",this._attListResizeHandler);this._usesIframe=Browser.isFF;this._attachIframe.src=AttachmentUpload._IFRAME_URL}AttachmentUpload._ATTACH_HTML='<li att="att" class="Attachment{1}"{2}>{0}</li>';AttachmentUpload._FILENAME_HTML="<span>{0}</span> "+(Loc.isBidi?Loc.RLM:Loc.LRM);AttachmentUpload._SIZE_HTML="<span>{0}</span>";AttachmentUpload._REMOVE_HTML='<img src="./clear.gif" key="remove" class="Remove g_remove" alt="{0}" title="{0}" />';AttachmentUpload._UPLOAD_HTML='<span>{0}</span> | <a key="cancel" href="#" class="CancelBtn">{1}</a>';AttachmentUpload._IFRAME_URL="AttachmentUploader.aspx?_ec=1";__p=AttachmentUpload.prototype={elt:null,_list:null,_ui:null,_attachIframe:null,_form:null,_total:null,_box:null,_attachments:[],_count:0,_uploading:0,_totalSize:0,_retryAttach:0,_startTime:0,_usesIframe:false,_fileInputHandler:null,_iFrameLoadHandler:null,_attListResizeHandler:null,_enabled:false};__p.dispose=function AttachmentUpload$dispose(){this._attachIframe.detachEvent("onload",this._iFrameLoadHandler);this._list.detachEvent("onresize",this._attListResizeHandler);Control.destroy(this)};__p.enable=function AttachmentUpload$enable(){if(this._enabled)return;this._enabled=true;$setDisplay(this._ui,true);this.Events.onuienabled.fire([this,{}])};__p.disable=function AttachmentUpload$disable(){if(!this._enabled)return;this._enabled=false;$setDisplay(this._ui,false)};__p.createPhotoCaptureDialog=function AttachmentUpload$createPhotoCaptureDialog(d){var b=ComposePage.photoCaptureData,c=$Cookie.getCookieValues(App.config.pdCookie),e="<object id='photoCapture' data='data:application/x-silverlight,' type='application/x-silverlight-2' width='747' height='528'><param name='source' value='"+ComposePage.photoCaptureData.xapFileUrl+"' />"+"<param name='onLoad' value='AttachmentUpload$onPhotoCaptureDialogLoaded' />"+"<param name='enableHtmlAccess' value='true' />"+"<param name='initParams' value='"+"EnableEffects="+b.effectsEnabled+","+"LMName="+d+","+"ReceiverDomain="+b.receiverDomain+","+(c["pcd"]?"SavedDeviceName="+c["pcd"]+",":"")+"PollingInterval="+b.pollInterval+"' />"+"</object>",a=new WebDialog(528,779,null,true,true,false,null);a.setContents(e);a.setCallback(this._onPhotoCaptureDialogClose);a.setImgPath(gAlertsImagePath);a.addCloseBox("Close");a.addCloseOnEscapeKey();ComposePage._photoCaptureDialog=a;a.show();$BSI.reportEvent("SelectClick.Messaging.Mail.LiveShot",{count:"1"})};function AttachmentUpload$onPhotoCaptureDialogLoaded(){var a=$("photoCapture");if(a){if(a.Content&&a.Content.PhotoCaptureCommunicator){a.Content.PhotoCaptureCommunicator.PhotoCaptureDone=ComposePage.attachmentList.onPhotoCaptureDone;a.Content.PhotoCaptureCommunicator.ClearSavedDevice=ComposePage.attachmentList.onClearSavedDevice;a.Content.PhotoCaptureCommunicator.PhotoCaptureCloseFromError=ComposePage.attachmentList.onPhotoCaptureCloseFromError}ComposePage._photoCaptureAppObj=a}}__p.onPhotoCaptureDone=function AttachmentUpload$onPhotoCaptureDone(d,c){var a=c.SavedDeviceName;if(a){var b=$Cookie.getCookieValues(App.config.pdCookie);b["pcd"]=a;$Cookie.setCookieValues(App.config.pdCookie,b,$Cookie.getPermanentExpirationDate())}ComposePage.attachmentList._closePhotoCaptureDialog()};__p.onPhotoCaptureCloseFromError=function AttachmentUpload$onPhotoCaptureCloseFromError(){ComposePage.attachmentList._closePhotoCaptureDialog()};__p._closePhotoCaptureDialog=function AttachmentUpload$_closePhotoCaptureDialog(){setTimeout(ComposePage._photoCaptureDialog.callbackAndHide,0)};__p.onClearSavedDevice=function AttachmentUpload$onClearSavedDevice(){var a=$Cookie.getCookieValues(App.config.pdCookie);delete a["pcd"];$Cookie.setCookieValues(App.config.pdCookie,a,$Cookie.getPermanentExpirationDate())};__p._onPhotoCaptureDialogClose=function AttachmentUpload$_onPhotoCaptureDialogClose(b,a){if(a==ComposePage._photoCaptureDialog.getCancelButtonValue())$BSI.reportEvent("Close.Messaging.Mail.LiveShot",{count:"1"});if(ComposePage._photoCaptureAppObj&&ComposePage._photoCaptureAppObj.parentNode){ComposePage._photoCaptureAppObj.parentNode.removeChild(ComposePage._photoCaptureAppObj);ComposePage._photoCaptureAppObj=null}ComposePage._photoCaptureDialog=null;if(_silverlightUploader!=null)_silverlightUploader.CompletePhotoCapture();return true};__p.createUploadControl=function AttachmentUpload$createUploadControl(e,a){if($CSIPerf!==null){$CSIPerf.setPerformanceId("SilverlightUploader");if($BSI!==null)$BSI.informNav();$CSIPerf.addCsd("size",ComposePage.uploadControlData.xapSize)}var b='<object tabIndex="-1" id="uploadControl" data="data:application/x-silverlight," type="application/x-silverlight-2" width="10" height="10"><param name="source" value="'+ComposePage.uploadControlData.xapFileUrl+'" />'+'<param name="onLoad" value="AttachmentUpload$onUploadControlLoaded" />'+'<param name="onError" value="AttachmentUpload$onUploadControlError" />'+'<param name="background" value="Transparent" />'+'<param name="windowless" value="true" />'+'<param name="enableHtmlAccess" value="true" />'+'<param name="allowHtmlPopupWindow" value="true" />'+'<param name="initParams" value="'+"SatchmoPostUrl="+a.satchmoPostUrl+","+"SkyDriveBaseUrl="+a.skyDriveBaseUrl+","+"SkyDriveInfoUrl="+a.skyDriveInfoUrl+","+"ProgressImageUrl="+a.progressImageUrl+","+"Canary="+a.canaryValue+","+"IsManagedUser="+a.isManagedUser+","+"IsRtl="+a.isRtl+","+"Market="+a.market+","+"MaxUploadBytes="+a.maxUploadBytes+","+"MaxUploadFileCount="+a.maxUploadFileCount+","+(ComposePage.photoCaptureData&&ComposePage.photoCaptureData.lmTimeout?"LMTimeout="+ComposePage.photoCaptureData.lmTimeout+",":"")+(ComposePage.photoCaptureData&&ComposePage.photoCaptureData.senderDomain?"SenderDomain="+ComposePage.photoCaptureData.senderDomain+",":"")+"EnabledFeatures="+a.enabledFeatures+'" />'+"</object>",d=$(_slContainerDivId),c=$(_dlContainerDivId);d.style.position="relative";c.style.position="absolute";e.innerHTML=b;_silverlightUploaderTimeoutId=setTimeout($CC(AttachmentUpload$onUploadControlError,[null,{errorMessage:"load timeout"}]),ComposePage.uploadControlData.loadTimeout);return $("uploadControl")};function AttachmentUpload$onUploadControlLoaded(){if(_silverlightUploaderTimeoutId){clearTimeout(_silverlightUploaderTimeoutId);_silverlightUploaderTimeoutId=null}var a=$("uploadControl");_silverlightUploader=a.Content.HotmailUploaderController;var c=$(_dlContainerDivId),b=$(_dlAttachmentsDivId);setTimeout(function(){c.style.display="none";b.style.display="none"},400);if(ComposePage.uploadControlData.isRtl==true)a.style.right="0";else a.style.left="0";if($BSI!==null){$BSI.informPVHead();$BSI.informLoaded()}}function AttachmentUpload$onUploadControlError(b,a){if(!_silverlightUploader){$(_slContainerDivId).style.position="absolute";$(_dlContainerDivId).style.position="relative";_useSilverlightUpload=false;AttachmentUpload$enableDownlevelInsertBar();$(_slContainerDivId).innerHTML="";ComposePage.attachmentList.dispose();ComposePage.attachmentList=new AttachmentUpload($("fAttachments"));setTimeout(Resize._resizeComposeHeader,1)}$WebWatson.submit("Silverlight upload control error: "+a.errorMessage,a.xamlFile||null,a.lineNumber||null,String.format("type: {0} method: {1}",a.errorType+"",a.methodName+""),a.errorCode||null,null,null,true)}function AttachmentUpload$enableDownlevelInsertBar(){$(_slContainerDivId)&&($(_slContainerDivId).style.display="none");$(_dlAttachmentsDivId)&&($(_dlAttachmentsDivId).style.display="block");var b=$getDescendantsByClass($("insertBarContainer"),"A","c_ml");for(var a=0;a<b.length;a++){b[a].disabled=false;b[a].className="c_ml"}}function AttachmentUpload$completePopoverDialog(b,a){return _silverlightUploader.CompletePopoverDialog(b,a)}__p.addAttachment=function AttachmentUpload$addAttachment(a){if(_isSilverlightSupportedBrowser)if(a=="photos")SilverlightUpsell.showUpsellDialog(HM.ContentId.PhotosSilverlightUpsell);else if(a=="docs")SilverlightUpsell.showUpsellDialog(HM.ContentId.DocsSilverlightUpsell);else this.addFile();else this.addFile()};__p.addFile=function AttachmentUpload$addFile(){if(this._uploading>0){alert(Res.strings.attach.uploadInProgressError);return false}try{var a=this._getUploadForm();this._fileInputHandler=$CD(this,this._onFileInputChange);a.fileInput.onchange=this._fileInputHandler;a.fileInput.click()}catch(b){if(this._retryAttach++<App.config.attach.attachRetries)this._attachIframe.src=AttachmentUpload._IFRAME_URL;else this._cleanupAttachFailure(b.number,"AttachmentUploader.aspx failed to download on initialization");return}if(this._usesIframe)$setDisplay(this._attachIframe,true);this._retryAttach=0};__p.insertUploadUi=function AttachmentUpload$insertUploadUi(b){var a=String.format(AttachmentUpload._UPLOAD_HTML,Res.strings.attach.uploadInProgress,Res.strings.attach.uploadCancel);this._uploading++;this._count++;this._insertAttachmentUi(b,a,true);return true};__p.insertAttachment=function AttachmentUpload$insertAttachment(a,c,d,b){this._count++;this._totalSize+=d;this._addAttachmentID(a);this._insertAttachmentUi(c,b,false,a)};__p.updateTotalSizeIndicator=function AttachmentUpload$updateTotalSizeIndicator(a){this._total.innerHTML=a};__p.remove=function AttachmentUpload$remove(a){ComposeServices.beginDeleteAttachment(a.id,this._totalSize,$CD(this,this._onRemove));this._removeAttachmentID(a.id);this._removeAttachmentUI(a)};__p.cancel=function AttachmentUpload$cancel(a){this._uploading--;this._resetUploadFrame();this._removeAttachmentUI(a)};__p.requiresSkyDriveFinalization=function AttachmentUpload$requiresSkyDriveFinalization(){return _silverlightUploader!=null&&_silverlightUploader.RequiresSkyDriveFinalization};__p.confirmOkToSend=function AttachmentUpload$confirmOkToSend(){var a=true;if(this._isUploading())a=confirm(Res.strings.attach.attachCurrentlyUploading);return a};__p.hasAttachments=function AttachmentUpload$hasAttachments(){if(_silverlightUploader!=null)return this.requiresSkyDriveFinalization()||_silverlightUploader.SatchmoAttachmentIds!="";else return $("fAttachments_data").value!=""};__p.updateAttachmentIdsFromSilverlightUploader=function AttachmentUpload$updateAttachmentIdsFromSilverlightUploader(){if(_silverlightUploader!=null&&!this.requiresSkyDriveFinalization()){var a=$("fAttachments_data");a.value=_silverlightUploader.SatchmoAttachmentIds}};__p.beginFinalizeAttachments=function AttachmentUpload$beginFinalizeAttachments(){var a=true;if(_silverlightUploader!=null){_silverlightUploader.IsEnabled=false;$("SkyDriveLibrary").value="";$("fAttachments_data").value="";if(this.requiresSkyDriveFinalization()){var b=_silverlightUploader.Library;if(b!=null){_silverlightUploader.BeginFinalizeSkyDriveLibrary(function(a){ComposePage.attachmentList.endFinalizeAttachments(a)});a=false}}else this.updateAttachmentIdsFromSilverlightUploader()}if(a)this.endFinalizeAttachments()};__p.endFinalizeAttachments=function AttachmentUpload$endFinalizeAttachments(b){if(b==null){if(this.requiresSkyDriveFinalization()){var a=$("SkyDriveLibrary");if(a!=null)a.value=_silverlightUploader.Library}ComposeActions.sendMsgFinalize()}else{_silverlightUploader.IsEnabled=true;ComposeActions.cancelMsgFinalize()}};__p._addAttachmentID=function AttachmentUpload$_addAttachmentID(a){a=encodeURIComponent(a);this._attachments.push(a);this._form.value=this._attachments.join("|")};__p._removeAttachmentID=function AttachmentUpload$_removeAttachmentID(a){a=encodeURIComponent(a);this._attachments.remove(a);this._form.value=this._attachments.join("|")};__p._insertAttachmentUi=function AttachmentUpload$_insertAttachmentUi(a,c,f,b){a=this._encodeHtml(a);var g=String.format(AttachmentUpload._FILENAME_HTML,a),h=String.format(AttachmentUpload._SIZE_HTML,c),e=String.format(AttachmentUpload._REMOVE_HTML,Res.strings.attach.removeAttachment),d=String.format(Res.strings.attach.uploadAttachFormat,g,h,e),i=String.format(AttachmentUpload._ATTACH_HTML,d,f?" Uploading":"",b?' id="'+b+'"':"");this._list.innerHTML+=i;if($B.Safari)Resize._resizeComposeHeader();this.enable();return true};__p._removeAttachmentUI=function AttachmentUpload$_removeAttachmentUI(a){if(this._count==1)this.disable();this._count--;this._list.removeChild(a);this._onResizeAttList();if($B.Safari)Resize._resizeComposeHeader()};__p._clearAttachmentUI=function AttachmentUpload$_clearAttachmentUI(){this.disable();this._count=0;var b=this._list.childNodes;for(var a=b.length-1;a>=0;--a)this._list.removeChild(b[a]);if($B.Safari)Resize._resizeComposeHeader()};__p._maybeResetAttachments=function AttachmentUpload$_maybeResetAttachments(){if(""==$("isFirstPL").value){this._form.value="";this._clearAttachmentUI()}$("isFirstPL").value=""};__p._rehydrate=function AttachmentUpload$_rehydrate(){if(""==this._form.value)return;attachments=this._form.value.split("|");var a="",b=0;for(var c=attachments.length-1;c>=0;--c){a=unescape(attachments[c]);this._attachments.push(encodeURIComponent(a));a=a.split("|");b=parseInt(a[3]);if(isNaN(b))b=0;this._totalSize+=b;this._count++}if(this._count>0)this.enable()};__p._getUploadForm=function AttachmentUpload$_getUploadForm(){return this._attachIframe.contentWindow.document.forms[0]};__p._isUploading=function AttachmentUpload$_isUploading(){return _silverlightUploader!=null?_silverlightUploader.IsUploading:this._uploading>0};__p._encodeHtml=function AttachmentUpload$_encodeHtml(c){var a=document.createElement("div"),b=document.createTextNode(c);a.appendChild(b);return a.innerHTML};__p._cleanupAttachFailure=function AttachmentUpload$_cleanupAttachFailure(a){var c=new Date-this._startTime,b=null;if(a=="-2147012605"){alert(Res.strings.attach.uploadFilenameTooLongError);return}else if(a=="-2147024891"||a==null)b=c>App.config.attach.uploadTimeout?Res.strings.attach.uploadTimeoutError:Res.strings.attach.uploadPostFailureError;else b=Res.strings.attach.uploadFileFailureError;if(this._retryAttach<=App.config.attach.attachRetries)this._resetUploadFrame();alert(b)};__p._getCurrentlyUploadingUiElt=function AttachmentUpload$_getCurrentlyUploadingUiElt(){var a=null,c=$tag(this._list,"li");for(var b=c.length-1;b>=0;b--){a=c[b];if($css.has(a,"Uploading"))break}return a};__p._resetUploadFrame=function AttachmentUpload$_resetUploadFrame(){this._attachIframe.stop&&this._attachIframe.stop();this._attachIframe.src=AttachmentUpload._IFRAME_URL};__p._stripPath=function AttachmentUpload$_stripPath(a){var b=a.lastIndexOf("\\");if(-1==b)b=a.lastIndexOf("/");return a.substr(b+1)};__p._scrollToBottom=function AttachmentUpload$_scrollToBottom(){this._box.scrollTop=this._box.scrollHeight};__p._onRemove=function AttachmentUpload$_onRemove(c,d,b,a){this.updateTotalSizeIndicator(a);this._totalSize=b};__p._onFileInputChange=function AttachmentUpload$_onFileInputChange(){var a=this._getUploadForm();if(a.fileInput.value.length>0){this._usesIframe&&$setDisplay(this._attachIframe,false);this.insertUploadUi(this._stripPath(a.fileInput.value));a.HiddenAttachments.value=this._form.value;this._startTime=new Date;a.upload.click();this._scrollToBottom()}};__p._onClick=function AttachmentUpload$_onClick(a){if(!("cancel"==a||"remove"==a))return false;var b=Control.getAncestorByAttr(event.srcElement,"att");switch(a){case "cancel":this.cancel(b);break;case "remove":this.remove(b)}return false};__p._onUploadFinished=function AttachmentUpload$_onUploadFinished(){if(""==this._attachIframe.src)return;var a=null,b=this._getCurrentlyUploadingUiElt();try{a=this._attachIframe.contentWindow}catch(h){this._cleanupAttachFailure(h.number,"AttachmentUploader.aspx failed to complete the file upload");if(this._uploading>0){this._removeAttachmentUI(b);this._uploading--}return}if(this._uploading>0&&a){var k=a.m_sFileName,f=a.m_sFileId,e=a.m_iFileSize,j=a.m_sUiFileSize,c=a.m_sFileSizeMeter,l=a.m_bSuccess,d=a.m_bShowMessage,i=a.m_sErrorDescription;if(typeof c!="undefined"&&c)this.updateTotalSizeIndicator(c);if(l){this._addAttachmentID(f);b.id=f;b._fileSize=e;this._totalSize+=e;var g=$tag(b,"span");g[0].innerHTML=k;g[1].innerHTML=j;$css.remove(b,"Uploading")}else this._removeAttachmentUI(b);if(d)alert(i);else if(typeof d=="undefined")this._cleanupAttachFailure(null,"AttachmentUploader.aspx failed to download after file upload.");else this._resetUploadFrame();this._uploading--}};__p._onResizeAttList=function(){};AttachmentUpload.createClass("AttachmentUpload");if(Browser.isIE6)__p._onResizeAttList=function AttachmentUpload$_onResizeAttList(){this._box.style.height=this._box.scrollHeight>53?"53px":"auto"};ComposeServices.beginDeleteAttachment=function ComposeServices$beginDeleteAttachment(b,a,c){HM.LFPP=function(){HM.DeleteUploadedAttachment_ec(b,a,c)};HM.LFPP()};function SpellChecker(){}SpellChecker.prototype={check:function SpellChecker$check(){alert(decodeURIComponent(Res.strings.spellChecker.nonIEBrowserCheckMessage))},removeAllMarkers:function SpellChecker$removeAllMarkers(){},onSend:function SpellChecker$onSend(){return true},dispose:function SpellChecker$dispose(){}};var SilverlightUpsell={},_hasOlderSLVersionInstalled=Silverlight.isInstalled();SilverlightUpsell.initialize=function SilverlightUpsell$initialize(){SilverlightUpsell._dialog=null;SilverlightUpsell._contentId=null};SilverlightUpsell.showUpsellDialog=function SilverlightUpsell$showUpsellDialog(a){SilverlightUpsell._contentId=a;var b=function(){var b=DemandLoadHandler.getContent(a);if(b){SilverlightUpsell._dialog=new WebDialog(null,b.dialogWidth,null,true,false,false);SilverlightUpsell._dialog.setContents(b.dialogContent);SilverlightUpsell._dialog.setImgPath(gAlertsImagePath);SilverlightUpsell._dialog.addCloseBox(gAlertsCloseBoxAltText);SilverlightUpsell._dialog.setCallback(SilverlightUpsell._upsellCallback);SilverlightUpsell._dialog.addCloseOnEscapeKey();gShowDialog(SilverlightUpsell._dialog)}};DemandLoadHandler.demandLoadContent([a],[b])};SilverlightUpsell.onInstallSilverlightClick=function SilverlightUpsell$onInstallSilverlightClick(){SilverlightUpsell._reportClick("accepted");var a=DemandLoadHandler.getContent(SilverlightUpsell._contentId);if(a){Infopane.show(a.infoPaneText,{pri:Infopane.ErrorPri.Medium});window.open(a.installLink);SilverlightUpsell._dialog.hide()}};SilverlightUpsell._upsellCallback=function SilverlightUpsell$_upsellCallback(){SilverlightUpsell._reportClick("cancel");SilverlightUpsell._dialog.hide()};SilverlightUpsell._reportClick=function SilverlightUpsell$_reportClick(b){var a=null;if(SilverlightUpsell._contentId==HM.ContentId.SlideshowSilverlightUpsell)a="slideshow";else if(SilverlightUpsell._contentId==HM.ContentId.PhotosSilverlightUpsell)a="photo";else if(SilverlightUpsell._contentId==HM.ContentId.DocsSilverlightUpsell)a="doc";else if(SilverlightUpsell._contentId==HM.ContentId.VideoPlaybackSilverlightUpsell)a="videoplayback";$BSI.reportEvent("rv.photoup",{upsellType:"Silverlight",upsellEntryPoint:a,endState:b})};Type.createStaticClass(SilverlightUpsell,"SilverlightUpsell");SilverlightUpsell.initialize();QuickAdd={download:function QuickAdd$download(a){if(!QuickAdd.val())return;if($QA.qajsloadcompleted&&$QA.clientstringsloadcompleted&&$QA.load)$QA.load(a);else{QuickAdd.loading();Loader.load($QA.css,$QA.script,function(){QuickAdd.onDownload(a)},Browser.isIE?$("bucketQA"):null)}},onDownload:function QuickAdd$onDownload(a){QuickAdd.val()&&$QA.load&&$QA.load(a)},val:function QuickAdd$val(){return typeof $QA!="undefined"},loading:function QuickAdd$loading(){var a=$("qa_main"),b=$("MainContent"),e=b.offsetHeight,d=e+"px",c=a.style;$css.add(a,"qa_vh");$css.remove(a,"DisplayNone");c.top=f(b)+"px";b.style.width=b.parentNode.clientWidth+1-a.clientWidth+"px";c.height!=d&&(c.height=d);$css.remove(a,"qa_vh");function f(a){var b=0;while(a){b+=a.offsetTop;a=a.offsetParent;if(a&&a.id&&a.id.toLowerCase()=="contentright")break}return b}}};Type.createStaticClass(QuickAdd,"QuickAdd");QuickAdd.val()&&$QA.autosearch&&$QA.autosearch.category&&QuickAdd.download($QA.autosearch.category);var ContactPickerConstants={};ContactPickerConstants.KeyCodes={NONE_SELECTED:-1,BACK_BUTTON:8,TAB:9,RETURN:13,SHIFT:16,ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,FF_SEMICOLON:59,SEMICOLON:186,COMMA:188,DELETE:46,SPACE:32};ContactPickerConstants.Constants={NONE:-1,IE:1,FIREFOX:2,FIREFOX3:5,SAFARI:3,OTHER_BROWSER:4,ROWS_PER_CONTAINER:6,PEOPLE:1,CATEGORIES:2,FAVORITES:3,RECENT:4,ADD:1,REMOVE:2,GLOBAL_ARRAY_EMAIL_INDEX:7,SAFARI_INPUT_WIDTH:18,PERSIST_SERVER_SIDE_ID:0,PERSIST_FULL_NAME:1,PERSIST_EMAIL:2,ONE_COL_DEFAULT_THRESHOLD:450,RESULTS_DDOWN_MAX_WIDTH:600,RESULTS_DDOWN_MIN_WIDTH:250,RESULTS_CELL_MARGIN:50,DEFAULT_ROWS_PER_CONTAINER:6,ONECOL_ROWS_PER_CONTAINER:3};ContactPickerConstants.Instrumentation={PeopleTab:0,CategoryTab:1,FavoritesTab:2,RecentTab:3,ClientDetectsContactMalformed:4,ServerDetectsContactMalformed:5,EditMalformedContact:6,DeleteMalformedContact:7,ExpandCategory:8,ShowAutoComplete:9};var AbchElement=function AbchElement(b,c,l){this.isCategory=false;this.isGroup=false;this.isFavorite=false;this.isSpacesFriend=false;this.emailIndex=0;this._emailArray=null;this.email=null;this.fullName="";this._clientID=ContactPickerConstants.Constants.NONE;this._uniqueSelectedElementID=0;this.isPicwOnly=l?true:false;this._isNew=false;this.isValid=true;if(b==null){this.email="";this._isNew=true}else{this._clientID=b;if(l){var d=ContactPickerCore.picwEmailArray;if(d){this.email=Microsoft.Live.ContactPicker.Util.htmlEncode(d[b]);this._emailArray=[this.email]}}else{var d=ContactPickerCore.contactData;if(d){var a=d[b];this.fullName=a[2];this.serverSideID=a[1];if(b<ContactPickerCore.contactCount){if(!c)c=0;this.emailIndex=c;if(a[6])if(b<ContactPickerCore.personCount){var e=d[b][6],k=e.length,f=0;this._emailArray=[];var i=false;for(var g=0;g<k;g++){var h=e[g][1],j=h.length;this._emailArray=this._emailArray.concat(h);if(f<=c&&c<f+j){i=true;this.serverSideContactID=e[g][0];this.email=h[c-f]}f+=j}if(!i&&k>0)this.serverSideContactID=e[0][0]}else{var m=a[6].length;if(this.emailIndex<m)this.email=a[6][this.emailIndex];this._emailArray=a[6]}this.isSpacesFriend=a[5]==0||a[5]==""?false:true;this.isGroup=a[3]==0||a[3]==""?false:true;this.isFavorite=a[4]==0||a[4]==""?false:true}else{this.isCategory=true;this.users=a[3]}}}}},CPDictionary=function CPDictionary(){this._dictionary={};this.count=0};CPDictionary.prototype={add:function CPDictionary$add(a,b){if(this._dictionary[a])return;this._dictionary[a]=b;this.count++},clear:function CPDictionary$clear(){this.count=0;this._dictionary={}},remove:function CPDictionary$remove(a){delete this._dictionary[a];this.count--},getPrimitive:function CPDictionary$getPrimitive(){return this._dictionary},getItem:function CPDictionary$getItem(b){var a=this._dictionary[b];if(typeof a=="undefined")return null;return a}};Type.registerNamespace("Microsoft.Live.ContactPicker.Util");Microsoft.Live.ContactPicker.Util={isNullOrEmpty:function isNullOrEmpty(a){return a==null||a==""},escapeRegex:function escapeRegex(a){return a.escapeRegex()},getCharCode:function getCharCode(b){var a=String.fromCharCode(b).toLowerCase();return a.charCodeAt(0)},concat:function concat(){var c=arguments.length,b=[];for(var a=0;a<c;a++)b[a]=arguments[a];return b.join("")},getBrowser:function Operations$getBrowser(){if(navigator.appName=="Microsoft Internet Explorer")return ContactPickerConstants.Constants.IE;if(navigator.appName=="Netscape")if(navigator.appVersion.indexOf("Safari")>-1)return ContactPickerConstants.Constants.SAFARI;else if(navigator.userAgent.indexOf("Firefox/3")!=-1)return ContactPickerConstants.Constants.FIREFOX3;else return ContactPickerConstants.Constants.FIREFOX},htmlEncode:function Operations$htmlEncode(a){if(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a))return a;return a.encodeHtml()},htmlDecode:function Operations$htmlDecode(a){if(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a))return a;return a.decodeHtml()},getPrivateMessageString:function Operations$getPrivateMessageString(){return '<span title="'+ContactPickerStrings.pmtt+'">'+"&lt;"+ContactPickerStrings.privateMessage+"&gt;"+"</span>"},mergePicwData:function Operations$mergePicwData(c,j,q,p,d){var f=[];if(j!=null){var i=c!=null?c.length:0,o=j.length,h=[],b=0;d=d==null?o+i:d;for(var g=0;g<o&&b<d;g++){var e=j[g];if(!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(e)){e=Microsoft.Live.ContactPicker.Util.htmlEncode(e.toLowerCase());var n=false;if(c!=null)for(var a=0;a<i;a++){var m=c[a],k=m._emailArray;if(k){var r=k.length;for(var l=0;l<r;l++){var s=k[l];if(s.toLowerCase()==e){if(!h[a]){f[b++]=m;h[a]=true}n=true;break}}}}if(!n&&(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(p)||e.charCodeAt(0)==p)){var m=new AbchElement(g,null,true);f[b++]=m}}}if(q)for(var a=0;a<i&&b<d;a++)if(!h[a])f[b++]=c[a]}return f}};Type.registerNamespace("Microsoft.Live.ContactPicker");Microsoft.Live.ContactPicker.Search=function Search(a,b){this._instanceName=a;this._base=$(this._instanceName+"$SearchBox");this._overlay=$(this._instanceName+"$SearchBoxOverlay");Control.create(this,this._base);this._input=$(this._instanceName+"$SearchInput");this._parent=b;this._searchImg=$(this._instanceName+"$SearchImg");this._searchCancelImg=$(this._instanceName+"$SearchCancelImg")};Microsoft.Live.ContactPicker.Search.prototype={isVisible:true,isInputVisible:true,_sourceList:null,_viewlist:null,_resultsList:null,_resultsBackbuffer:null,_prevQuery:"",_lastInput:"",_click:function Search$_click(){if(this._input.style.display!="none")$callFocus(this._input)},clear:function Search$clear(){this._lastInput="";this._input.value="";if(this._resultsList!=null){this._prevQuery="";this._resultsBackbuffer=null;this._hideResults();this._resultsList=null;this._viewlist=null}this._parent._showSelectAll()},dispose:function Search$dispose(){Control.destroy(this);this._base=null;this._searchImg=null;this._searchCancelImg=null;this._input=null;this._overlay=null;this._parent=null},cutHandler:function Search$cutHandler(){setTimeout($CD(this,this.searchHandler),0)},pasteHandler:function Search$pasteHandler(){if(!event.ctrlKey)setTimeout($CD(this,this.searchHandler),0)},_onChangeHandler:function Search$_onChangeHandler(){var c=Microsoft.Live.ContactPicker.Util.getBrowser();if(c!=ContactPickerConstants.Constants.FIREFOX||c==ContactPickerConstants.Constants.FIREFOX3)return;var a=false,b=this._input.value.length-this._lastInput.length;if(!b)if(this._input.value!=this._lastInput)a=true;else a=false;else if(-1<=b&&b<=1)a=false;else if(b>1)a=true;else a=true;this._lastInput=this._input.value;if(a)this.pasteHandler()},searchKeyDown:function Search$searchKeyDown(){if(this._viewlist==null)this._updateLists();var a=Microsoft.Live.ContactPicker.Util.getCharCode(event.keyCode);switch(a){case ContactPickerConstants.KeyCodes.RETURN:event.returnValue=false;return false;break;case ContactPickerConstants.KeyCodes.ESC:setTimeout($CD(this,this.clear),0);return}},_populateBackbuffer:function Search$_populateBackbuffer(c){var a=this._getResultsList(c);if(a){var b=null;b=this._getFormattedResults(a,this._viewlist.id.indexOf("FavoritesList")!=-1);this._resultsBackbuffer=b}},searchHandler:function Search$searchHandler(){if(this._input.value==""){this.clear();return}if(this._viewlist==null)this._updateLists();this._populateBackbuffer(this._input.value.toLowerCase().charCodeAt(0));var a="",b=this._input.value;if(b=="")return;else if(b!=this._prevQuery){a=this._getResults(b);setTimeout($CD(this,function(){this._syncSelectionBetweenSearch()}),0);this._prevQuery=b}else return;if(a==""&&this._viewlist.childNodes.length!=0)a=String.format('<div class="NoResults">{0}</div>',ContactPickerStrings.noResults);this._resultsList.innerHTML=a;this._showResults()},_getResults:function Search$_getResults(a){var c="";a=Microsoft.Live.ContactPicker.Util.escapeRegex(a);a=a.replace(/</gi,"&lt;");a=a.replace(/>/gi,"&gt;");if(this._resultsBackbuffer==null)return "";var n=this._resultsBackbuffer.length,h='([3][\\"]?>)('+a+")([^<]*?)",i='([3][\\"]?>)([^<]*? )('+a+")([^<]*?</div>)",j='([4][\\"]?>)('+a+")([^<]*?</div>)";for(var d=0;d<n;d++){var b=this._resultsBackbuffer[d],e=new RegExp(h,"gi"),k=e.exec(b);if(k)c+=b.replace(e,'$1<span class="FontWeight">$2</span>$3');else{var f=new RegExp(i,"gi"),m=f.exec(b);if(m)c+=b.replace(f,'$1$2<span class="FontWeight">$3</span>$4');else{var g=new RegExp(j,"gi"),l=g.exec(b);if(l)c+=b.replace(g,'$1<span class="FontWeight">$2</span>$3')}}}return c},_processResults:function Search$_processResults(d){var a=d,b="people,|favorites,",c=new RegExp(b,"gi");a=a.replace(c,"results,");b="<a .*?</a>";c=new RegExp(b,"gi");a=a.replace(c,"&nbsp;");b='tabIndex=[\\"]?-1[\\"]?';c=new RegExp(b,"gi");a=a.replace(c,"tabIndex=0");b="</span>";c=new RegExp(b,"gi");a=a.replace(c,"");b="<span class=[^>]*?>";c=new RegExp(b,"gi");a=a.replace(c,"");if(Microsoft.Live.ContactPicker.Util.getBrowser()!=ContactPickerConstants.Constants.IE)a=this._shouldCheckElt(a);return a},_syncSelectionBetweenSearch:function Search$_syncSelectionBetweenSearch(){var a=this._parent.getSelectedContacts();for(var b=a.length;b--;)if(a[b]!=null){var d=a[b]._clientID,e=a[b].emailIndex>=0?a[b].emailIndex:0,c=$([this._parent._instanceName,"results",d,e].join(","));if(c)this._parent._updateCheckedElement(c.parentNode.parentNode,c,false,true)}},_shouldCheckElt:function Search$_shouldCheckElt(e){var b=e,a="",i=/results,[0-9]+,[0-9]+,(true|false)\"/gi,c=e.match(i);if(c!=null){var g=this._parent.__getSelectContactsDictionary(),j=c.length;for(var f=j;f--;){a=c[f];var d=a.replace(/results,/,""),d=d.replace(/\"/,"");if(g.getItem(d)){var h=new RegExp(a,"i");b=b.replace(h,a+' CHECKED _selected="true" ')}}}return b},_getFormattedResults:function Search$_getFormattedResults(b,e){var a=[],f=b.length;for(var c=f;c--;){var d=new AbchElement(b[c]);if(!d.isCategory)if(!e||d.isFavorite)a[a.length]=Microsoft.Live.ContactPicker.Util.concat('<div class="RowContainer">',this._processResults(this._sourceList.childNodes[b[c]].innerHTML),"</div>")}return a},_getResultsList:function Search$_getResults(b){var a=null;if(ContactPickerCore.searchIndex)a=ContactPickerCore.searchIndex[b];return a},_showResults:function Search$_showResults(){if(this._resultsList.style.display=="block")return;this._resultsList.style.display="block";this._viewlist.style.display="none";this._searchImg.style.display="none";this._searchCancelImg.style.display="block";this._parent._hideSelectAll()},_hideResults:function Search$_hideResults(){if(this._resultsList.style.display=="none")return;this._resultsList.style.display="none";this._viewlist.style.display="block";this._searchImg.style.display="block";this._searchCancelImg.style.display="none"},_updateLists:function Search$_updateLists(){this._sourceList=this._parent.getSourceList();this._viewlist=this._parent.getWorkingList();this._resultsList=this._parent.getWorkingList(true)},hide:function Search$hide(){this._base.style.display="none";this.isVisible=false},hideOverlay:function Search$hideOverlay(){this._overlay.style.display="none";this._input.style.display="block";this.isInputVisible=true},show:function Search$show(){this._base.style.display="block";this.isVisible=true},showOverlay:function Search$showOverlay(){this._overlay.style.display="block";this._input.style.display="none";this.isInputVisible=false},isActive:function Search$isActive(){return this._resultsList.style.display=="block"},resultList:function Search$resultList(){return this._resultsList},focus:function Search$focus(){if(this.isInputVisible)$callFocus(this._input)}};Microsoft.Live.ContactPicker.Search.createClass("Microsoft.Live.ContactPicker.Search");Type.registerNamespace("Microsoft.Live.ContactPicker");Microsoft.Live.ContactPicker.SearchIndexer=function CPSearchIndexer(){this.Events={onsearchindexready:new $Event};this._iCallback=$CD(this,this._indexCallBack)};Microsoft.Live.ContactPicker.SearchIndexer.prototype={_timerId:0,RETRY_INTERVAL:1e3,RETRY_PROCESSING:500,start:function SearchIndexer$start(){this._indexCallBack()},_buildIndex:function SearchIndexer$_buildIndex(){ContactPickerCore.searchIndex=[];var e=ContactPickerCore.contactData.length;for(var b=0;b<e;b++){var d=ContactPickerCore.contactData[b][0],f=d.length,g=0;for(var c=0;c<f;c++){var a=d.charCodeAt(c);if(ContactPickerCore.searchIndex[a]==undefined)ContactPickerCore.searchIndex[a]=[];ContactPickerCore.searchIndex[a][ContactPickerCore.searchIndex[a].length]=b}}},_checkTransform:function SearchIndexer$_checkTransform(){if(typeof ContactPickerCore=="undefined")setTimeout(this._iCallback,this.RETRY_INTERVAL);else if(typeof ContactPickerCore.searchIndex=="undefined")setTimeout(this._iCallback,this.RETRY_INTERVAL);else if(ContactPickerCore.lock)setTimeout(this._iCallback,this.RETRY_PROCESSING);else if(ContactPickerCore.searchIndex!=null){if(ContactPickerCore.searchIndex.length>=0)return true}else return this._indexList();return false},_indexCallBack:function SearchIndexer$_indexCallBack(){var a=this._checkTransform();if(a)this.Events.onsearchindexready.fire([this])},_indexList:function SearchIndexer$_indexList(){this._LOCKRESOURCE();this._buildIndex();this._UNLOCKRESOURCE();return true},_LOCKRESOURCE:function SearchIndexer$_LOCKRESOURCE(){ContactPickerCore.lock=true},_UNLOCKRESOURCE:function SearchIndexer$_UNLOCKRESOURCE(){ContactPickerCore.lock=false}};Microsoft.Live.ContactPicker.SearchIndexer.createClass("Microsoft.Live.ContactPicker.SearchIndexer");Type.registerNamespace("Microsoft.Live.ContactPicker");Microsoft.Live.ContactPicker.ContactPicker=function ContactPicker(instance_name){this.Events={oncontactadded:new $Event,oncontactremoved:new $Event,onhide:new $Event,onshow:new $Event,onallselected:new $Event,onalldeselected:new $Event};this._instanceName=instance_name;this._base=$(this._instanceName+"$ContactPickerContainer");Control.create(this,this._base);if(this._base.style.display.toLowerCase()=="none")this.isVisible=false;this._selectedTab=this._getSelectedTab();this._search=new Microsoft.Live.ContactPicker.Search(this._instanceName,this);this._peopleListContainer=$(this._instanceName+"$PeopleListContainer");this._categoryListContainer=$(this._instanceName+"$CategoryListContainer");this._favoriteListContainer=$(this._instanceName+"$FavoritesListContainer");this._recentListContainer=$(this._instanceName+"$RecentListContainer");this._peopleList=$(this._instanceName+"$PeopleList");this._categoryList=$(this._instanceName+"$CategoryList");this._favoriteList=$(this._instanceName+"$FavoritesList");this._recentList=$(this._instanceName+"$RecentList");this._initializeControl();this._selectAll=$(this._instanceName+"$SelectAllCheckbox");this._selectAllCategory=$(this._instanceName+"$SelectAllCheckboxCategory");this._selectedSelectAll=this._selectAll;this._selectAllText=$(this._instanceName+"$SelectAllText");this._selectedContacts=new CPDictionary;this._selectedContactsServer=$(this._instanceName+"$SelectedContacts");this._selectedContactsServer.value="";eval(String.format("this._selectedLookup = {0}$Lookup;",this._instanceName));this._preSelectedContacts=[];this._peopleListNoContacts=$(this._instanceName+"$NoContacts");this._categoryListNoContacts=$(this._instanceName+"$NoCategories");this._favoriteListNoContacts=$(this._instanceName+"$NoFavorites");this._recentListNoContacts=$(this._instanceName+"$NoRecent");this._searchIndexer=new Microsoft.Live.ContactPicker.SearchIndexer;this._searchIndexer.Events.onsearchindexready.attach($CD(this,this._onSearchIndexReady));this._searchIndexer.start();this._suppressSelectAll=false;this.contactPickerUsed=false};Microsoft.Live.ContactPicker.ContactPicker.prototype={isVisible:true,_onContactAddedDelegate:null,_onContactRemovedDelegate:null,_onCategoryExpandedDelegate:null,base:function ContactPicker$base(){return this._base},_initializeControl:function ContactPicker$_initializeControl(){this.READY=0;this.NOT_READY=1;this._state=this.NOT_READY},_onSearchIndexReady:function ContactPicker$_onSearchIndexReady(g){var n=g[0],m=g[1],b=[],e=[],d=[],f=[],k=0,i=0,h=0,l=ContactPickerCore.contactData.length,j=ContactPickerCore.contactCount;for(var c=0;c<l;c++){var a=new AbchElement(c);if(c<j){b[k++]=a;if(a.isFavorite)e[i++]=a}else d[h++]=a}this._peopleList.innerHTML=this._getContactListHtml(b,ContactPickerConstants.Constants.PEOPLE);this._favoriteList.innerHTML=this._getContactListHtml(e,ContactPickerConstants.Constants.FAVORITES);this._categoryList.innerHTML=this._getContactListHtml(d,ContactPickerConstants.Constants.CATEGORIES);if(ContactPickerConfigs.RecentTabVisible&&ContactPickerCore.picwEmailArray!=null&&ContactPickerCore.picwEmailArray.length>0){f=Microsoft.Live.ContactPicker.Util.mergePicwData(b,ContactPickerCore.picwEmailArray,false,null,ContactPickerConfigs.RecentListMaxLength);this._recentList.innerHTML=this._getContactListHtml(f,ContactPickerConstants.Constants.RECENT)}this._selectedContactsServer.value="";this._preselect();this._handleNoContacts(b,e,d,f);$(this._instanceName+"$Loading").style.display="none";this._state=this.READY},_handleNoContacts:function ContactPicker$_handleNoContacts(c,b,a,d){if(c.length==0)this._peopleListNoContacts.style.display="block";if(b.length==0)this._favoriteListNoContacts.style.display="block";if(a.length==0)this._categoryListNoContacts.style.display="block";if(d.length==0)this._recentListNoContacts.style.display="block"},_preselect:function ContactPicker$_preselect(){for(var a=this._preSelectedContacts.length;a--;)this.onContactAdded([this,this._preSelectedContacts[a]])},_getContactListHtml:function ContactPicker$_getContactListHtml(i,b){var n='<div class="RowContainer Visibility"><div class="Row Unselected" onmouseover="if(window.Control)Control.invoke(\'Microsoft.Live.ContactPicker.ContactPicker\', \'_onMouseOverContact\', event, this);" onmouseout="if(window.Control)Control.invoke(\'Microsoft.Live.ContactPicker.ContactPicker\', \'_onMouseFromContact\', event, this);" onclick="if(window.Control)Control.invoke(\'Microsoft.Live.ContactPicker.ContactPicker\', \'_onToggleSelection\', event);"><div class="Cell1">{0}</div><div class="Cell2"><input class="Checkbox" id="{1}" type="checkbox" /></div><div class="Cell3">{2}</div><div class="Cell4">{3}</div></div>',p='<div class="Row Unselected" onmouseover="if(window.Control)Control.invoke(\'Microsoft.Live.ContactPicker.ContactPicker\', \'_onMouseOverContact\', event, this);" onmouseout="if(window.Control)Control.invoke(\'Microsoft.Live.ContactPicker.ContactPicker\', \'_onMouseFromContact\', event, this);" onclick="if(window.Control)Control.invoke(\'Microsoft.Live.ContactPicker.ContactPicker\', \'_onToggleSelection\', event);"><div class="Cell1">&nbsp;</div><div class="Cell2"><input class="Checkbox" id="{0}" tabIndex="-1" type="checkbox" /></div><div class="FontSecondaryColor Cell3">{1}</div><div class="Cell4">{2}</div></div>',m='<div class="CategoryRowContainer CategoryUnselected"><div class="CategorySubContainer" onmouseover="if(window.Control)Control.invoke(\'Microsoft.Live.ContactPicker.ContactPicker\', \'_onMouseOverCategory\', event, this);" onmouseout="if(window.Control)Control.invoke(\'Microsoft.Live.ContactPicker.ContactPicker\', \'_onMouseOutCategory\', event, this);" onclick="if(window.Control)Control.invoke(\'Microsoft.Live.ContactPicker.ContactPicker\', \'_onToggleSelection\', event);"><div class="CategoryRow"><div class="Cell1">{0}</div><div class="Cell2"><input class="Checkbox" id="{1}" type="checkbox" /></div><div class="Cell3"><span class="FontWeight">{2}</span></div><div class="Cell4">{3} {4}</div></div>',o='<div class="CategoryContainer" style="display: none;"><div class="CategoryRow"><div class="Cell1"></div><div class="Cell2">&nbsp;</div><div class="Cell3">{0}</div><div class="Cell4">{1}</div></div></div>',k='<a href="javascript:;" onkeydown="if(window.Control)Control.invoke(\'Microsoft.Live.ContactPicker.ContactPicker\', \'_onToggle\', event);if(event.keyCode != ContactPickerConstants.KeyCodes.TAB)return false;"><img alt="'+ContactPickerStrings.expand+'" class="Collapsed" border="0" onclick="if(window.Control)Control.invoke(\'Microsoft.Live.ContactPicker.ContactPicker\', \'_onToggle\', event);" src="'+ContactPickerStrings.expandImg+'" /></a>',l="";if(i!=null){var r=i.length;for(var j=0;j<r;j++){var a=i[j],c=b==ContactPickerConstants.Constants.CATEGORIES?a.users:a._emailArray,f=c.length;this._shouldPreselect(a);var e="";if(b==ContactPickerConstants.Constants.CATEGORIES)e=String.format(m,f>0?k:"&nbsp;",this.makeCheckboxId(b,a._clientID,0,false),Microsoft.Live.ContactPicker.Util.concat('<span class="FontWeight">',a.fullName,"</span>"),f,f==1?ContactPickerStrings.categoryCountSingular:ContactPickerStrings.categoryCountPlural);else e=String.format(n,f>1?k:"&nbsp;",this.makeCheckboxId(b,a._clientID,0,a.isPicwOnly),a.isGroup?'<span class="FontWeight">'+a.fullName+"</span>":Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a.fullName)?a.email:a.fullName,a.isSpacesFriend&&Microsoft.Live.ContactPicker.Util.isNullOrEmpty(c[0])&&!ContactPickerCore.hideEmails?Microsoft.Live.ContactPicker.Util.getPrivateMessageString():c[0]?c[0]:"");var q=b==ContactPickerConstants.Constants.CATEGORIES?0:1;for(var d=q;d<f;d++)if(b==ContactPickerConstants.Constants.CATEGORIES){var h=new AbchElement(c[d]),g=h.email;if(g!=null)e+=String.format(o,h.fullName==""?g:h.fullName,h.isSpacesFriend&&Microsoft.Live.ContactPicker.Util.isNullOrEmpty(g)&&!ContactPickerCore.hideEmails?Microsoft.Live.ContactPicker.Util.getPrivateMessageString():g)}else e+=String.format(p,this.makeCheckboxId(b,a._clientID,d,a.isPicwOnly),a.fullName!=""?a.fullName:c[d],c[d]);e+=b==ContactPickerConstants.Constants.CATEGORIES?"</div></div>":"</div>";l+=e}}return l},_shouldPreselect:function ContactPicker$_shouldPreselect(a){var f=a.serverSideID?a.serverSideID:a.serverSideContactID;if(this._selectedLookup[f]==true){var d=0;if(!a.isCategory&&!a.isGroup){var c=a._emailArray;for(var b=c.length;b--;)if(this._selectedLookup[c[b].toLowerCase()]==true){d++;var e=new AbchElement(a._clientID,b,a.isPicwOnly);this._preSelectedContacts[this._preSelectedContacts.length]=e}}if(d==0)this._preSelectedContacts[this._preSelectedContacts.length]=a}else if(!a.isCategory&&!a.isGroup){var c=a._emailArray;for(var b=c.length;b--;)if(this._selectedLookup[c[b].toLowerCase()]==true){var e=new AbchElement(a._clientID,b,a.isPicwOnly);this._preSelectedContacts[this._preSelectedContacts.length]=e}}else if(this._selectedLookup[a.fullName.toLowerCase()]==true)this._preSelectedContacts[this._preSelectedContacts.length]=a},_selectAllHandler:function ContactPicker$_selectAllHandler(){if(this._state!=this.READY)return;var b=event.srcElement,a=b.checked;switch(this._selectedTabName){case "PeopleTab":this.Events[a?"onallselected":"onalldeselected"].fire([this,ContactPickerConstants.Constants.PEOPLE]);this._checkAll(this._peopleList,a);break;case "CategoryTab":this.Events[a?"onallselected":"onalldeselected"].fire([this,ContactPickerConstants.Constants.CATEGORIES]);this._checkAll(this._categoryList,a,true);break;case "FavoritesTab":this.Events[a?"onallselected":"onalldeselected"].fire([this,ContactPickerConstants.Constants.FAVORITES]);this._checkAll(this._favoriteList,a)}this.contactPickerUsed=true},_checkAll:function ContactPicker$_checkAll(e,d,c){var a=$tag(e,"input");for(var b=a.length;b--;){this._updateCheckedElement(c?a[b].parentNode.parentNode.parentNode.parentNode:a[b].parentNode.parentNode,a[b],c,d);if(!c)this._syncSelection(a[b])}},_onMouseOverCategory:function ContactPicker$_onMouseOverCategory(b){if(!b)return;var a=b.parentNode;if($css.has(a,"CategorySelected"))return;$css.add(a,"CategoryHover")},_onMouseOutCategory:function ContactPicker$_onMouseOutCategory(b){if(!b)return;var a=b.parentNode;if(a._selected=="false"||!a._selected)a.className="CategoryRowContainer CategoryUnselected"},_onMouseOverContact:function ContactPicker$_onMouseOverContact(a){if(!a)return;if($css.has(a,"Selected"))return;$css.add(a,"Hover")},_onMouseFromContact:function ContactPicker$_onMouseFromContact(a){if(Microsoft.Live.ContactPicker.Util.getBrowser()!=ContactPickerConstants.Constants.IE){var b=a.children[1].children[0].checked;if(!b)a.className="Row Unselected"}else if(a._selected=="false"||!a._selected)a.className="Row Unselected"},_onTabChanged:function ContactPicker$_onTabChanged(){var a=window.event.srcElement;while(a.tagName.toLowerCase()!="li")a=a.parentNode;if(a==this._selectedTab)return;a.className="Selected";this._selectedTab.className="";this._selectedTab=a;this._selectedTabName=this._getTabName();this._updateUI()},_onToggle:function ContactPicker$_onToggle(c){var a=c||event.srcElement;if(a.tagName.toLowerCase()=="a"){if(event.keyCode!=ContactPickerConstants.KeyCodes.RETURN)return;a=a.firstChild}var b=a.className;switch(b){case "Collapsed":a.title=Microsoft.Live.ContactPicker.Util.htmlDecode(ContactPickerStrings.collapse);a.className="Expanded";a.src=ContactPickerStrings.collapseImg;this._toggleAllSubNodes(a,0);break;case "Expanded":a.title=Microsoft.Live.ContactPicker.Util.htmlDecode(ContactPickerStrings.expand);a.className="Collapsed";a.src=ContactPickerStrings.expandImg;this._toggleAllSubNodes(a,-1)}},_toggleAllSubNodes:function ContactPicker$_toggleAllSubNodes(d,c){var b=d.parentNode.parentNode.parentNode,a=b.parentNode;if(a.className.indexOf("CategorySubContainer")!=-1||a.className=="CategoryContainer"){this._toggleAllCategorySubNodes(a,c==0?"block":"none");return}if(c==-1)a.className="RowContainer Visibility";else a.className="RowContainer";while(b=b.nextSibling)b.childNodes[1].firstChild.tabIndex=c},_toggleAllCategorySubNodes:function ContactPicker$_toggleAllCategorySubNodes(c,b){var a=c.firstChild;while(a=a.nextSibling)a.style.display=b},_onToggleSelection:function ContactPicker$_onToggleSelection(){var c=false,a=event.srcElement,d=a.tagName.toLowerCase();if(this._shouldToggleExpand(a))return;if(d=="img")return;else if(d=="input"){var b=a;a=a.parentNode.parentNode;if(a.className.indexOf("CategoryRow")!=-1){c=true;while(a.className.indexOf("CategoryRowContainer")==-1)a=a.parentNode}this._updateCheckedElement(a,b,c,b.checked);this._syncSelection(b);this._updateAssociatedControl(b);this.contactPickerUsed=true;return}else if(a.className.indexOf("CategoryRow")!=-1){c=true;while(a.className.indexOf("CategoryRowContainer")==-1)a=a.parentNode}else if(a.className.indexOf("Row")==-1){while(a.className.indexOf("Row")==-1)a=a.parentNode;if(a.className.indexOf("CategoryRow")!=-1){c=true;while(a.className.indexOf("CategoryRowContainer")==-1)a=a.parentNode}}if(!c)var b=a.childNodes[1].firstChild;else var b=a.firstChild.firstChild.childNodes[1].firstChild;this._updateCheckedElement(a,b,c);this._syncSelection(b);this._updateAssociatedControl(b);this.contactPickerUsed=true},_shouldToggleExpand:function ContactPicker$_shouldToggleExpand(b){if(b.className.indexOf("Cell1")!=-1){var a=b;while(a){if(a.nodeType==1)if(a.tagName.toLowerCase()=="img")break;a=a.firstChild}if(a){this._onToggle(a);return true}}return false},_updateAssociatedControl:function ContactPicker$_updateAssociatedControl(c){var d=c.id,b=d.split(","),a=null;a=new AbchElement(b[2],b[3],b[4]=="true");if(c.checked)this.Events.oncontactadded.fire([this,a]);else this.Events.oncontactremoved.fire([this,a])},_updateCheckedElement:function ContactPicker$_updateCheckedElement(d,a,e,c){if(typeof c!="undefined")a.checked=c;else a.checked=!a.checked;if(this._selectedSelectAll.checked&&!a.checked)this._selectedSelectAll.checked=false;this._updateSelectedItems(a);var b=e==true?"CategoryRowContainer Category":"Row ";b+=a.checked==true?"Selected":"Unselected";d._selected=a.checked;d.className=b},_updateSelectedItems:function ContactPicker$_updateSelectedItems(c){var d=c.getAttribute("id"),a=d.split(","),e=a.length,b=a[2]+","+a[3]+","+a[4];if(c.checked){this._updateServerSelectedContacts(b,true);this._selectedContacts.add(b,true)}else{this._selectedContacts.remove(b);this._updateServerSelectedContacts(b,false)}},_updateServerSelectedContacts:function ContactPicker$_updateServerSelectedContacts(e,d){var c=e.split(","),a=new AbchElement(c[0],c[1],c[2]=="true"),b=["[",a.serverSideID,";",escape(a.fullName),";",escape(a.email),";",a.isGroup,";",a.isCategory,";",a.serverSideContactID?a.serverSideContactID:0,"]"].join("");if(!this._selectedContacts.getItem(e)&&d)this._selectedContactsServer.value=(this._selectedContactsServer.value==""?"":this._selectedContactsServer.value+",")+b;if(!d){this._selectedContactsServer.value=this._selectedContactsServer.value.replace(","+b,"");this._selectedContactsServer.value=this._selectedContactsServer.value.replace(b+",","");this._selectedContactsServer.value=this._selectedContactsServer.value.replace(b,"")}},_updateUI:function ContactPicker$_updateUI(){this._search.clear();switch(this._selectedTabName){case "PeopleTab":if(!this._suppressSelectAll)this._manageSelectAllCheckbox(false);this._enableSelectAll(true);this._search.hideOverlay();this._search.clear();this._updatePageVisibility("block","none","none","none");break;case "CategoryTab":if(!this._suppressSelectAll)this._manageSelectAllCheckbox(true);this._enableSelectAll(true);this._search.showOverlay();this._search.clear();this._updatePageVisibility("none","block","none","none");break;case "FavoritesTab":if(!this._suppressSelectAll)this._manageSelectAllCheckbox(false);this._enableSelectAll(true);this._search.hideOverlay();this._search.clear();this._updatePageVisibility("none","none","block","none");break;case "RecentTab":if(!this._suppressSelectAll)this._manageSelectAllCheckbox(false);this._enableSelectAll(false);this._search.showOverlay();this._search.clear();this._updatePageVisibility("none","none","none","block")}},_enableSelectAll:function ContactPicker$_enableSelectAll(a){this._selectAll.disabled=!a},_manageSelectAllCheckbox:function ContactPicker$_manageSelectAllCheckbox(a){this._selectAll.style.display=a?"none":"block";this._selectAllCategory.style.display=a?"block":"none";this._selectedSelectAll=a?this._selectAllCategory:this._selectAll;this._selectedSelectAll.checked=this._shouldChecked(a)},_shouldChecked:function ContactPicker$_shouldChecked(f){if(!f){var c=(this._selectedTabName=="PeopleTab"?this._peopleList:this._favoriteList).innerHTML;if(c=="")return false;var g='class=["]?Row Unselected["]?',i=new RegExp(g,"gi"),h=i.exec(c);if(h)return false;return true}else{var b=this._categoryList.childNodes.length,d=this.getSelectedContacts(),a=0;for(var e=d.length;e--;)if(d[e].isCategory)a++;return b>0&&b==a}return false},_updatePageVisibility:function ContactPicker$_updatePageVisibility(c,a,b,d){this._peopleListContainer.style.display=c;this._categoryListContainer.style.display=a;this._favoriteListContainer.style.display=b;this._recentListContainer.style.display=d},_syncSelection:function ContactPicker$_syncSelection(a){if(this._isSyncFromSearchResult(a))a=this._syncSearchResult(a);switch(this._selectedTabName){case "PeopleTab":this._syncWithOtherTabs(a,ContactPickerConstants.Constants.PEOPLE);break;case "FavoritesTab":this._syncWithOtherTabs(a,ContactPickerConstants.Constants.FAVORITES);break;case "RecentTab":this._syncWithOtherTabs(a,ContactPickerConstants.Constants.RECENT)}},_syncSearchResult:function ContactPicker$_syncSearchResult(c){var a=c.getAttribute("id"),b=a.split(",");b[1]=this._selectedTabName=="PeopleTab"?"people":"favorite";a=b.join(",");this._syncUpdate(a,c.checked);return $(a)},_isSyncFromSearchResult:function ContactPicker$_isSyncFromSearchResult(a){var b=a.getAttribute("id");return b.indexOf("results")!=-1?true:false},_syncUpdate:function ContactPicker$_syncUpdate(c,b){var a=$(c);if(a==null)return;this._updateCheckedElement(a.parentNode.parentNode,a,false,b)},_syncWithOtherTabs:function ContactPicker$_syncWithOtherTabs(c,e){var a=[];a[0]=ContactPickerConstants.Constants.PEOPLE;a[1]=ContactPickerConstants.Constants.FAVORITES;if(ContactPickerConfigs.RecentTabVisible)a[2]=ContactPickerConstants.Constants.RECENT;var f=a.length,g=c.getAttribute("id");for(var b=0;b<f;b++){var d=a[b];if(e!=d){var h=this._changeIdType(g,d);this._syncUpdate(h,c.checked)}}},_changeIdType:function ContactPicker$_changeIdType(b,c){var a=b.split(",");return this.makeCheckboxId(c,a[2],a[3],a[4])},_getSelectedTab:function ContactPicker$_getSelectedTab(){var a=$(this._instanceName+"$PeopleTab");while(a){if(a.className){this._selectedTabName=this._getTabName(a);return a}a=a.nextSibiling}return null},_getTabName:function ContactPicker$_getTabName(a){return (a||this._selectedTab).id.substring(this._instanceName.length+1)},dispose:function ContactPicker$dispose(){Control.destroy(this);if(this._search)this._search.dispose();this._base=null},hide:function ContactPicker$hide(){this._base.style.display="none";this.isVisible=false;this.Events.onhide.fire([this])},show:function ContactPicker$show(){this._base.style.display="block";this.isVisible=true;if(this._selectedTabName=="CategoryTab"){if(this._selectedSelectAll!=null)this._selectedSelectAll.focus()}else if(this._search!=null)this._search.focus();this.Events.onshow.fire([this])},reAssociateControl:function ContactPicker$reAssociateControl(a){if(!this._onContactAddedDelegate||!a)return;this.clearAll();if(this._associatedControl){this._associatedControl.Events.oncontactadded.detach(this._onContactAddedDelegate);this._associatedControl.Events.oncontactremoved.detach(this._onContactRemovedDelegate);this._associatedControl.Events.oncategoryexpand.detach(this._onCategoryExpandedDelegate);this._associatedControl.detachAssociatedCPEvents()}var c=a.selectedAbchElements.length;for(var b=c;b--;)this.onContactAdded([null,a.selectedAbchElements[b]]);this.associateControl(a);a.associateControl(this)},getSourceList:function ContactPicker$getSourceList(){var a=this._instanceName+"$PeopleList";return $(a)},getWorkingList:function ContactPicker$getWorkingList(a){switch(this._selectedTabName){case "PeopleTab":var b=a?this._instanceName+"$PeopleResultsList":this._instanceName+"$PeopleList";return $(b);break;case "FavoritesTab":var b=a?this._instanceName+"$FavoritesResultsList":this._instanceName+"$FavoritesList";return $(b)}return null},_hideSelectAll:function ContactPicker$_hideSelectAll(){this._selectedSelectAll.style.display="none";this._selectAllText.style.display="none"},hideSelectAll:function ContactPicker$hideSelectAll(){this._hideSelectAll();this._suppressSelectAll=true},_showSelectAll:function ContactPicker$_showSelectAll(){if(this._suppressSelectAll)return;this._selectedSelectAll.style.display="block";this._selectAllText.style.display="block"},showSelectAll:function ContactPicker$showSelectAll(){this._suppressSelectAll=false;this._showSelectAll()},associateControl:function ContactPicker$associateControl(a){this._associatedControl=a;this._onContactAddedDelegate=$CD(this,this.onContactAdded);this._onContactRemovedDelegate=$CD(this,this.onContactRemoved);this._onCategoryExpandedDelegate=$CD(this,this.onCategoryExpand);this._associatedControl.Events.oncontactadded.attach(this._onContactAddedDelegate);this._associatedControl.Events.oncontactremoved.attach(this._onContactRemovedDelegate);this._associatedControl.Events.oncategoryexpand.attach(this._onCategoryExpandedDelegate)},makeCheckboxId:function ContactPicker$makeCheckboxId(e,d,c,b){var a;switch(e){case ContactPickerConstants.Constants.PEOPLE:a="people";break;case ContactPickerConstants.Constants.FAVORITES:a="favorite";break;case ContactPickerConstants.Constants.CATEGORIES:a="category";break;case ContactPickerConstants.Constants.RECENT:a="recent";break;default:return null}return Microsoft.Live.ContactPicker.Util.concat(this._instanceName,",",a,",",d,",",c,",",b)},onContactAdded:function ContactPicker$onContactAdded(a){var c=a[0],b=a[1];this.addOrRemoveContact([b,true])},onContactRemoved:function ContactPicker$onContactRemoved(a){var c=a[0],b=a[1];this.addOrRemoveContact([b,false])},addOrRemoveContact:function ContactPicker$addOrRemoveContact(d){var a=d[0],e=d[1],c=a._clientID;if(c==ContactPickerConstants.Constants.NONE)return;var b;if(a.isCategory)b=ContactPickerConstants.Constants.CATEGORIES;else if(a.isPicwOnly)b=ContactPickerConstants.Constants.RECENT;else b=ContactPickerConstants.Constants.PEOPLE;var f=this.makeCheckboxId(b,c,a.emailIndex,a.isPicwOnly);this._updateContactFromEvent(f,a.isCategory,e)},_updateContactFromEvent:function ContactPicker$_updateContactFromEvent(e,d,c){var a=$(e);if(a!=null)if(d){var b=a;while(b.className.indexOf("CategoryRowContainer")==-1)b=b.parentNode;this._updateCheckedElement(b,a,true,c)}else{a.checked=c;this._syncWithOtherTabs(a)}},onCategoryExpand:function ContactPicker$onCategoryExpand(c){var i=c[0],a=c[1],g=a._clientID;if(g==ContactPickerConstants.Constants.NONE)return;var h=null,b=a.users,e=b.length;this.onContactRemoved([this,a]);for(var d=e;d--;){var f=new AbchElement(b[d]);this.onContactAdded([this,f])}},__getSelectContactsDictionary:function ContactPicker$__getSelectContactsDictionary(){return this._selectedContacts},getSelectedContacts:function ContactPicker$getSelectedContacts(){var b=this._selectedContacts.getPrimitive(),c=[],d=0;for(keys in b){if(FunctionHelper.isSpecialMember(b,keys))continue;var a=keys.split(",");c[d]=new AbchElement(a[0],a[1],a[2]=="true");d++}return c},clearAll:function ContactPicker$clearAll(){this._checkAll(this._peopleList,false);this._checkAll(this._categoryList,false,true);this._checkAll(this._favoriteList,false);this._checkAll(this._recentList,false);this._search.clear()}};Microsoft.Live.ContactPicker.ContactPicker.createClass("Microsoft.Live.ContactPicker.ContactPicker");Type.registerNamespace("Microsoft.Live.ContactPicker");Microsoft.Live.ContactPicker.AutoComplete=function AutoComplete(instanceName){this.Events={onismanagedrestricted:new $Event,oncontactadded:new $Event,oncontactremoved:new $Event,oncategoryexpand:new $Event};this._instanceName=instanceName;this._elt=$(this._instanceName+"$AutoComplete");Control.create(this,this._elt);this._input=$(this._instanceName+"$InputBox");this._resultsContainer=$(this._instanceName+"$ResultsContainer");this._inputDiv=$(this._instanceName+"$InputDiv");this._inputUL=$(this._instanceName+"$InputUL");this._inputULInitialContents=this._inputUL.innerHTML;this._inputBoxLi=$(this._instanceName+"$InputBoxLi");this._browserType=Microsoft.Live.ContactPicker.Util.getBrowser();this.selectedAbchElements=[];this._addAbchElementIndexOverride=-1;this._selectedContactsServer=$(this._instanceName+"$SelectedContacts");eval(String.format("this._selectedLookup = {0}$Lookup;",this._instanceName));eval(String.format("this._freeSelectedLookup = {0}$FreeSelected;",this._instanceName));this._inputBoxLi.attachEvent("onclick",$CD(this,this._acCancelBubble));document.attachEvent("onclick",$CD(this,this._globalClickHandler));this._setTimeOutHandle=0;this._lastInput="";this._textRuler=$(this._instanceName+"$TextRuler");this._currentKeyFocusElt=-1;this._previousSelectedElt=null;this._searchIndexer=new Microsoft.Live.ContactPicker.SearchIndexer;this._searchIndexer.Events.onsearchindexready.attach($CD(this,this._onSearchIndexReady));this._searchIndexer.start()};Microsoft.Live.ContactPicker.AutoComplete.prototype={_resultRowCount:0,_currentAutoCompleteSelectedIndex:ContactPickerConstants.KeyCodes.NONE_SELECTED,_lastAutoCompleteSelectedIndex:ContactPickerConstants.KeyCodes.NONE_SELECTED,_isWaitingOnReadyNotification:false,_isReady:false,_scrollBottomAnchor:0,_uniqueElementID:0,_inputULInitialContents:"",_origMarkup:"",_countIt:0,_onContactAddedDelegate:null,_onContactRemovedDelegate:null,_onCategoryExpandedDelegate:null,_onAllSelectedDelegate:null,_onAllDeselectedDelegate:null,_associatedControl:null,_emailPattern:"[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?",_keyHandled:false,_pasteWhileInitializing:false,_resultsDropDownContactNameWidth:"",_resultsDropDownEmailWidth:"",_displayResultsInOneColumn:false,_rowsPerContainer:ContactPickerConstants.Constants.DEFAULT_ROWS_PER_CONTAINER,synchResultsDropDownWidthToSearchBox:false,resultsDropDownOneColumnWidthThreshold:ContactPickerConstants.Constants.ONE_COL_DEFAULT_THRESHOLD,wasclVerifyRecipient:null,populateInput:function AutoComplete$populateInput(a){if(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a))return;this._input.value=a;this._doSearch()},_setResultsDropDownWidth:function AutoComplete$_setResultsDropDownWidth(a){var b;if(a<ContactPickerConstants.Constants.RESULTS_DDOWN_MIN_WIDTH)a=ContactPickerConstants.Constants.RESULTS_DDOWN_MIN_WIDTH;if(a>ContactPickerConstants.Constants.RESULTS_DDOWN_MAX_WIDTH)a=ContactPickerConstants.Constants.RESULTS_DDOWN_MAX_WIDTH;if(a<this.resultsDropDownOneColumnWidthThreshold){this._rowsPerContainer=ContactPickerConstants.Constants.ONECOL_ROWS_PER_CONTAINER;this._displayResultsInOneColumn=true;b=a-ContactPickerConstants.Constants.RESULTS_CELL_MARGIN}else{this._rowsPerContainer=ContactPickerConstants.Constants.DEFAULT_ROWS_PER_CONTAINER;this._displayResultsInOneColumn=false;b=a/2-ContactPickerConstants.Constants.RESULTS_CELL_MARGIN}var c=$(this._instanceName+"$ResultsContainer");if(c)c.style.width=a+"px";this._resultsDropDownContactNameWidth=b+"px";this._resultsDropDownEmailWidth=b+"px"},_measureString:function AutoComplete$_measureString(a){if(a==" "||a=="")return 50;var b=Microsoft.Live.ContactPicker.Util.htmlEncode(a);this._textRuler.innerHTML=b;var c=this._textRuler.offsetWidth;return c+25},_rowClickHandler:function AutoComplete$_rowClickHandler(){this._acCancelBubble();var a=event.srcElement;while(a&&a!=this._resultsContainer){if(a.tagName.toLowerCase()=="tr"){var b=a.getAttribute("isPicwOnly").toLowerCase()=="true";this._makeSelection(a.getAttribute("cid"),a.getAttribute("eid"),true,b);break}a=a.parentElement}},_globalClickHandler:function AutoComplete$_globalClickHandler(){this._createElementFromInput(false)},_inputUlClickHandler:function AutoComplete$_inputUlClickHandler(){this._createElementFromInput(false);this._acCancelBubble()},_autoCompleteClickHandler:function AutoComplete$_autoCompleteClickHandler(){this._createElementFromInput(true);this._acCancelBubble()},_scrollInputToBottom:function AutoComplete$_scrollInputToBottom(){this._inputDiv.scrollTop=this._inputDiv.scrollHeight},_onChangeHandler:function AutoComplete$_onChangeHandler(){if(this._browserType!=ContactPickerConstants.Constants.FIREFOX)return;var a=false,b=this._input.value.length-this._lastInput.length;if(!b)if(this._input.value!=this._lastInput)a=true;else a=false;else if(-1<=b&&b<=1)a=false;else if(b>1)a=true;else a=true;this._lastInput=this._input.value;if(a){this._setInputWidth(this._input.value);this._doPaste()}else this._doSearch()},_pasteHandler:function AutoComplete$_pasteHandler(){if(this._browserType==ContactPickerConstants.Constants.FIREFOX)return;setTimeout($CD(this,this._doPaste),0)},_doPaste:function AutoComplete$_doPaste(){if(!this._isReady){this._pasteWhileInitializing=true;return}if(ContactPickerCore.isManagedRestricted){this._input.value="";this.Events.onismanagedrestricted.fire([this,null])}var a=this._input.value;if(a==""){this._setInputWidth(" ");this._clearResults();return}if(this._addElementsByString(a)){this._input.value="";this._lastInput="";this._setInputWidth(" ");setTimeout($CD(this,this._scrollInputToBottom),50);return}if(a)this._doSearch()},completeFreeFormEmail:function AutoComplete$completeFreeFormEmail(){if(this._input.value!=""){if(ContactPickerCore.isManagedRestricted){this._input.value="";this.Events.onismanagedrestricted(this,null);return}this._currentAutoCompleteSelectedIndex=ContactPickerConstants.Constants.NONE;this._completeEntry(false)}},_preselect:function AutoComplete$_preselect(){if(this._selectedLookup==null||this._freeSelectedLookup==null)return;var e=ContactPickerCore.contactData.length;for(var b=e;b--;){var f=new AbchElement(b),a=this._shouldPreselect(f);if(a)this._addAbchElement(a,false)}var d=this._freeSelectedLookup.length;for(var c=d;c--;){var g=this._freeSelectedLookup[c],a=new AbchElement;a.email=g;this._addAbchElement(a,false)}this._persistState()},_persistState:function AutoComplete$_persistState(){this._selectedContactsServer.value="";var e=this.selectedAbchElements.length,c=[];for(var b=0;b<e;b++){var d="",a=this.selectedAbchElements[b];if(!a.isValid)continue;if(a.fullName==null)a.fullName="";if(a.email==null)a.email="";var f=["[",a.serverSideID,";",escape(a.fullName),";",escape(a.email),";",a.isGroup,";",a.isCategory,";",a.serverSideContactID?a.serverSideContactID:0,"]"].join("");c[b]=f}d=c.join(",");this._selectedContactsServer.value=d},_shouldPreselect:function AutoComplete$_shouldPreselect(a){var e=a.serverSideID?a.serverSideID:a.serverSideContactID;if(e&&this._selectedLookup[e]==true){var d=0;if(!a.isCategory&&!a.isGroup){var b=a._emailArray;if(b)for(var c=b.length;c--;)if(this._selectedLookup[b[c].toLowerCase()]==true){d++;var f=new AbchElement(a._clientID,c,a.isPicwOnly);return f}}if(d==0)return a}if(!a.isCategory&&!a.isGroup){var b=a._emailArray;if(b)for(var c=b.length;c--;)if(this._selectedLookup[b[c].toLowerCase()]==true){var f=new AbchElement(a._clientID,c,a.isPicwOnly);return f}}else if(this._selectedLookup[a.fullName.toLowerCase()])return a;return null},_reset:function AutoComplete$_reset(){if(this._input)this._input.value="";if(this._resultsContainer)this._resultsContainer.style.display="none";this._currentAutoCompleteSelectedIndex=ContactPickerConstants.KeyCodes.NONE_SELECTED;this._lastAutoCompleteSelectedIndex=ContactPickerConstants.KeyCodes.NONE_SELECTED},_clearResults:function AutoComplete$_clearResults(){this._resultsContainer.innerHTML="";this._resultsContainer.style.display="none"},_isEmailValid:function AutoComplete$_isEmailValid(a){if(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a))return false;var b=new RegExp(this._emailPattern,"ig"),c=b.test(a);return c},_isDomainValid:function AutoComplete$_isDomainValid(a){if(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a))return false;var b=";home.com;attbi.com;example.com;hotmail.co;yaho.com;hotmai.com;yahoo.co;yahoomail.com;direcway.com;homail.com;ims-ms-daemon;local.transport;ethome.net.tw;ethome.net.tw;hotmil.com;hotmial.com;yhoo.com;collegeclub.com;sbcglobal.com;hotamil.com;hotmail.com.au;yaoo.com;yahoo.net;yhaoo.com;mail.hotmail.com;passport.com;kimo.com.tw;yahooo.com;yahho.com;ol.com;gateway.net;hotmail.com.mx;otmail.com;htomail.com;aol.co;altavista.com;hotmaill.com;taiwan.com;hotmail.con;ahoo.com;hotmail.om;hotmail.net;hormail.com;hotail.com;hotamail.com;yahoo.om;homtail.com;msn.net;sprint.ca;angelfire.com;cm1.ethome.net.tw;yohoo.com;a0l.com;alo.com;msn.de;gmail.co;",c=this._getBetween(a,"@","");return !this._containsOneOf(b,c)},_containsOneOf:function AutoComplete$_containsOneOf(b,a){if(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a))return false;return b.indexOf(";"+a.toLowerCase()+";")>-1},_containsStartsWith:function AutoComplete$_containsStartsWith(b,a){if(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a))return false;return b.indexOf(";"+a.toLowerCase())>-1},_isInWhiteList:function AutoComplete$_isWhiteList(a,b){return b?this._containsStartsWith(ContactPickerCore.emailWhiteList,a):this._containsOneOf(ContactPickerCore.emailWhiteList,a)},_isEmailAndDomainValid:function AutoComplete$_isEmailAndDomainValid(a){var c=this._isEmailValid(a),b=this._isDomainValid(a);return (c||!ContactPickerCore.performValidEmailCheck)&&b},markContactAsInvalid:function AutoComplete$markContactAsInvalid(b){var a=$(b);if(a){$css.remove(a,"Block");$css.add(a,"BlockInvalid");a.title=Microsoft.Live.ContactPicker.Util.htmlDecode(ContactPickerStrings.malformedContact)}},_contactIsInvalid:function AutoComplete$_contactIsInvalid(a){return $css.has(a,"BlockInvalid")},_validateEmail:function AutoComplete$_validateEmail(b,c){var a=true;if(!this._isEmailAndDomainValid(b))a=false;else if(AutoCompleteConfigs.CallVerifyRecipients)a=this.wasclVerifyRecipient(b,c);return a},_completeEntry:function AutoComplete$_completeEntry(e){var c=$(this._instanceName+"$R"+(this._currentAutoCompleteSelectedIndex+1));if(c==null){if(ContactPickerCore.isManagedRestricted){this._input.value="";this.Events.onismanagedrestricted.fire([this,null]);return}var b=this._input.value;if(b=="")return;var b=b.replace(/^\s+|\s+$/g,""),a=new AbchElement,f=this._isEmailValid(b),d=Microsoft.Live.ContactPicker.Util.htmlEncode(b);if(f)a.email=d;else a.fullName=d;this._addAbchElement(a,e);this.Events.oncontactadded.fire([this,a]);this._persistState()}else{var g=c.getAttribute("isPicwOnly").toLowerCase()=="true";this._makeSelection(c.getAttribute("cid"),c.getAttribute("eid"),e,g)}},_clearLostFocusTimeout:function AutoComplete$_clearLostFocusTimeout(){clearTimeout(this._setTimeOutHandle)},_makeSelection:function AutoComplete$_makeSelection(e,a,b,d){this._clearLostFocusTimeout();abchElement=new AbchElement(e,null,d);if(abchElement._emailArray)abchElement.email=abchElement._emailArray[a];abchElement._selectedElementID=Microsoft.Live.ContactPicker.Util.concat(abchElement._clientID," ",a);if(!ContactPickerCore.allowDuplicateSelection){var c=this._isAlreadySelected(abchElement);this._reset();if(c)return}abchElement._selectedElementID=Microsoft.Live.ContactPicker.Util.concat(abchElement._clientID,"-",a);abchElement.emailIndex=a;this._addAbchElement(abchElement,b);this.Events.oncontactadded.fire([this,abchElement]);this._persistState()},_isAlreadySelected:function AutoComplete$_isAlreadySelected(a){var d=false;if(a){var f=!a.isCategory&&!a.isGroup,e=this.selectedAbchElements.length;for(var c=0;c<e;++c){var b=this.selectedAbchElements[c];if(b&&b._clientID==a._clientID&&(!f||b.email==a.email)){d=true;break}}}return d},_editOrRemoveContact:function AutoComplete$_editOrRemoveContact(d){var f=d["UniqueSelectedElementID"],h=d["FireEvent"],i=d["IsEdit"],j=Microsoft.Live.ContactPicker.Util.concat(this._instanceName,"$",f),e=$(j);if(e){var g=this.selectedAbchElements.length;for(var a=0;a<g;a++)if(this.selectedAbchElements[a]._uniqueSelectedElementID==f){var b=this.selectedAbchElements[a];this.selectedAbchElements.splice(a,1);if(i){var c=null;if(!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(b.email))c=b.email;else if(!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(b.fullName))c=b.fullName;if(!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(c))this._startEditing(e,a,Microsoft.Live.ContactPicker.Util.htmlDecode(c))}else{this._inputUL.removeChild(e);if(h){this.Events.oncontactremoved.fire([this,b]);this._persistState()}}break}}},_startEditing:function AutoComplete$_startEditing(b,c,a){if(b&&!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a)){this._addAbchElementIndexOverride=c;this._inputUL.replaceChild(this._inputBoxLi,b);$css.add(this._inputBoxLi,"InputBoxContainerEdit");this._input.value=a;this._doSearch()}},_finishEditing:function AutoComplete$_finishEditing(){this._addAbchElementIndexOverride=-1;this._inputUL.insertBefore(this._inputBoxLi,null);$css.remove(this._inputBoxLi,"InputBoxContainerEdit")},_currentlyEditing:function AutoComplete$_currentlyEditing(){return $css.has(this._inputBoxLi,"InputBoxContainerEdit")},_keyUp:function AutoComplete$_keyUp(c){var b=c||Microsoft.Live.ContactPicker.Util.getCharCode(event.keyCode);if(b==ContactPickerConstants.KeyCodes.SHIFT)this._isSpecialKey=false;var a=true;if(ContactPickerCore.selectionMaximum>0&&this.selectedAbchElements.length>=ContactPickerCore.selectionMaximum){event.returnValue=false;a=false}else{if(this._keyHandled){this._keyHandled=false;a=false}if(!this._input.value.length){this._setInputWidth(" ");this._clearResults();if(this._currentlyEditing()){this._finishEditing();setTimeout($CD(this,this._setInputFocus),50)}a=false}}if(a)this._doSearch()},_clearInput:function AutoComplete$_clearInput(){this._input.value=""},_deleteElement:function AutoComplete$_deleteElement(){if(this.selectedAbchElements.length>0){var b=this.selectedAbchElements[this.selectedAbchElements.length-1],a=this.selectedAbchElements[this.selectedAbchElements.length-1]._uniqueSelectedElementID;this._editOrRemoveContact({UniqueSelectedElementID:a,FireEvent:true,IsEdit:false});this._clearResults();if(this.selectedAbchElements.length==0){this._reset();return}}},deleteAllElements:function AutoComplete$deleteAllElements(){var c=this.selectedAbchElements.length;for(var a=c-1;a>=0;a--){var b=this.selectedAbchElements[a]._uniqueSelectedElementID;this._editOrRemoveContact({UniqueSelectedElementID:b,FireEvent:true,IsEdit:false})}this._reset();this._lastInput="";this._setInputWidth(" ");this._clearResults()},_createElementFromInput:function AutoComplete$_createElementFromInput(a){var b=this._input.value.replace(/^\s+|\s+$/g,"");if(b==""){if(a)setTimeout($CD(this,this._setInputFocus),50)}else this._completeEntry(a)},_checkIfMatch:function AutoComplete$_checkIfMatch(a){a=a.toLowerCase();return this._getContactRows(a)||this._isInWhiteList(a,true)},_focusOutInput:function AutoComplete$_focusOutInput(){if(this._browserType==ContactPickerConstants.Constants.FIREFOX3||this._browserType==ContactPickerConstants.Constants.SAFARI)this._updateSelectedElt(true)},_focusOutMainDiv:function AutoComplete$_focusOutMainDiv(){if(this._currentKeyFocusElt!=-1)this._updateSelectedElt(true)},_keyDownForContainer:function AutoComplete$_keyDownForContainer(b){if(event.srcElement==this._input&&!b)return;var a=b||Microsoft.Live.ContactPicker.Util.getCharCode(event.keyCode);if(!event.ctrlKey)switch(a){case ContactPickerConstants.KeyCodes.KEY_LEFT:case ContactPickerConstants.KeyCodes.KEY_RIGHT:this._keyHandled=true;this._selectByKeyboard(a);break;case ContactPickerConstants.KeyCodes.BACK_BUTTON:case ContactPickerConstants.KeyCodes.DELETE:this._acCancelBubble();this._deleteSelectedElt();$callFocus(this._input);break;case ContactPickerConstants.KeyCodes.TAB:break;default:this._input.focus();this._keyDown(a)}},_assignFromChar:function AutoComplete$_assignFromChar(a,b){if(a=="")return b;else return a},_keyDown:function AutoComplete$_keyDown(c){if(c)this._updateSelectedElt(true);var b=c||Microsoft.Live.ContactPicker.Util.getCharCode(event.keyCode),a="";if(this._browserType==ContactPickerConstants.Constants.FIREFOX3||this._browserType==ContactPickerConstants.Constants.SAFARI)if(b!=ContactPickerConstants.KeyCodes.KEY_LEFT&&b!=ContactPickerConstants.KeyCodes.KEY_RIGHT&&b!=ContactPickerConstants.KeyCodes.DELETE&&b!=ContactPickerConstants.KeyCodes.BACK_BUTTON)this._updateSelectedElt(true);switch(b){case ContactPickerConstants.KeyCodes.FF_SEMICOLON:a=this._assignFromChar(a,";");if(this._browserType!=ContactPickerConstants.Constants.FIREFOX&&this._browserType!=ContactPickerConstants.Constants.FIREFOX3)break;case ContactPickerConstants.KeyCodes.COMMA:a=this._assignFromChar(a,",");case ContactPickerConstants.KeyCodes.SEMICOLON:a=this._assignFromChar(a,";");if(this._isSpecialKey)break;case ContactPickerConstants.KeyCodes.SPACE:a=this._assignFromChar(a," ");var d=this._input.value+a;if(this._checkIfMatch(d))break;case ContactPickerConstants.KeyCodes.TAB:if(!this._checkIfMatch(this._input.value)&&!this._input.value)break;case ContactPickerConstants.KeyCodes.RETURN:this._keyHandled=true;this._createElementFromInput(true);event.returnValue=false;return false;break;case ContactPickerConstants.KeyCodes.ESC:if(this._resultsContainer.style.display=="block")setTimeout($CD(this,this._clearResults),0);else setTimeout($CD(this,this._clearInput),0);this._keyHandled=true;return false;break;case ContactPickerConstants.KeyCodes.BACK_BUTTON:if(this._input.value.length==0){if(this._browserType==ContactPickerConstants.Constants.FIREFOX3||this._browserType==ContactPickerConstants.Constants.SAFARI)if(this._currentKeyFocusElt!=-1){this._deleteSelectedElt();return}this._deleteElement();this._keyHandled=true}break;case ContactPickerConstants.KeyCodes.DELETE:if(this._currentKeyFocusElt!=-1)this._deleteSelectedElt();break;case ContactPickerConstants.KeyCodes.SHIFT:this._isSpecialKey=true;return;break;case ContactPickerConstants.KeyCodes.KEY_UP:case ContactPickerConstants.KeyCodes.KEY_DOWN:this._keyHandled=true;this._selectByArrowKeys(b);return;break;case ContactPickerConstants.KeyCodes.KEY_LEFT:case ContactPickerConstants.KeyCodes.KEY_RIGHT:if(this._browserType==ContactPickerConstants.Constants.FIREFOX3)this._inputDiv.focus();this._keyDownForContainer(b)}if(c)this._keyUp(c)},_selectByKeyboard:function AutoComplete$_selectByKeyboard(a){if(a!=ContactPickerConstants.KeyCodes.KEY_LEFT&&a!=ContactPickerConstants.KeyCodes.KEY_RIGHT)return;if(ContactPickerCore.isRTL)if(a==ContactPickerConstants.KeyCodes.KEY_LEFT)a=ContactPickerConstants.KeyCodes.KEY_RIGHT;else if(a==ContactPickerConstants.KeyCodes.KEY_RIGHT)a=ContactPickerConstants.KeyCodes.KEY_LEFT;var c=this._input.value,b=this._inputUL.children;if(a==ContactPickerConstants.KeyCodes.KEY_LEFT){if(c=="")if(this._currentKeyFocusElt==-1){if(b.length==2)return;this._currentKeyFocusElt=b.length-2}else if(this._currentKeyFocusElt>1)this._currentKeyFocusElt--}else if(this._currentKeyFocusElt==-1)return;else if(this._currentKeyFocusElt+1!=b.length-1)this._currentKeyFocusElt++;this._updateSelectedElt(false)},_deleteSelectedElt:function AutoComplete$_deleteSelectedElt(){if(this._currentKeyFocusElt==-1||!this._previousSelectedElt)return;var b=this._previousSelectedElt.id,a=b.split("$");if(a&&a.length==2)b=a[1];this._currentKeyFocusElt=-1;this._editOrRemoveContact({UniqueSelectedElementID:b,FireEvent:true,IsEdit:false})},_updateSelectedElt:function AutoComplete$_updateSelectedElt(a){if(this._currentKeyFocusElt==-1)return;if(this._previousSelectedElt||a)if($css.has(this._previousSelectedElt,"BlockInvalid"))$css.remove(this._previousSelectedElt,"SelectedInvalid");else $css.remove(this._previousSelectedElt,"Selected");if(a){this._currentKeyFocusElt=-1;this._previousSelectedElt=null}else{this._previousSelectedElt=this._inputUL.children[this._currentKeyFocusElt];if(this._previousSelectedElt){this._inputDiv.scrollTop=this._previousSelectedElt.offsetTop;this._inputDiv.focus();if($css.has(this._previousSelectedElt,"BlockInvalid"))$css.add(this._previousSelectedElt,"SelectedInvalid");else $css.add(this._previousSelectedElt,"Selected")}}},_setInputWidth:function AutoComplete$_setInputWidth(a){var b=this._measureString(a);this._input.style.width=b+"px"},_setLoadingIndicator:function AutoComplete$_setLoadingIndicator(){this._resultsContainer.innerHTML='&nbsp;<img class="LoadingIcon" src="'+ContactPickerStrings.loadingSmallImg+'"/>';this._resultsContainer.style.display="block";this._isWaitingOnReadyNotification=true},_doSearch:function AutoComplete$_doSearch(){if(this.synchResultsDropDownWidthToSearchBox&&this._inputDiv)this._setResultsDropDownWidth(this._inputDiv.offsetWidth);var b=this._input.value;this._setInputWidth(b);if(!this._isReady){this._setLoadingIndicator();return}var a=this._getContactRows(b.toLowerCase());if(a!=""){if(this._resultsContainer){this._resultsContainer.innerHTML=['<table cellpadding="0" cellspacing="0" class="ResultsTable">',a,"</table>"].join("");if(this._resultsContainer.style.display!="block")this._resultsContainer.style.display="block"}this._selectRow(0);if(this._browserType==ContactPickerConstants.Constants.IE)setTimeout($CD(this,this._selectFirstRow),50);this._resultsContainer.scrollTop=0}else this._clearResults()},_selectFirstRow:function AutoComplete$_selectFirstRow(){this._selectRow(0)},_selectByArrowKeys:function AutoComplete$_selectByArrowKeys(a){if(a==ContactPickerConstants.KeyCodes.KEY_DOWN){if(this._currentAutoCompleteSelectedIndex<this._resultRowCount-1)this._selectRow(this._currentAutoCompleteSelectedIndex+1)}else if(this._currentAutoCompleteSelectedIndex>0)this._selectRow(this._currentAutoCompleteSelectedIndex-1)},_selectRow:function AutoComplete$_selectRow(d){this._lastAutoCompleteSelectedIndex=this._currentAutoCompleteSelectedIndex;this._currentAutoCompleteSelectedIndex=d;if(this._lastAutoCompleteSelectedIndex!=ContactPickerConstants.Constants.NONE){var b=$(this._instanceName+"$R"+(this._lastAutoCompleteSelectedIndex+1));if(b)this._onResultLeave(b)}if(this._currentAutoCompleteSelectedIndex!=ContactPickerConstants.Constants.NONE){var c=$(this._instanceName+"$R"+(this._currentAutoCompleteSelectedIndex+1));if(c)this._onResultHover(c);if(this._currentAutoCompleteSelectedIndex>this._scrollBottomAnchor)this._scrollBottomAnchor=this._currentAutoCompleteSelectedIndex;if(this._currentAutoCompleteSelectedIndex<this._scrollBottomAnchor-this._rowsPerContainer)this._scrollBottomAnchor=this._currentAutoCompleteSelectedIndex+(this._rowsPerContainer+1);if(this._lastAutoCompleteSelectedIndex!=ContactPickerConstants.KeyCodes.NONE_SELECTED)if(this._currentAutoCompleteSelectedIndex>this._lastAutoCompleteSelectedIndex){if(this._currentAutoCompleteSelectedIndex>=this._scrollBottomAnchor){var a=$(this._instanceName+"$R"+(this._currentAutoCompleteSelectedIndex-this._rowsPerContainer));if(a)this._resultsContainer.scrollTop=a.offsetTop}}else if(this._currentAutoCompleteSelectedIndex<this._scrollBottomAnchor-this._rowsPerContainer){var a=$(this._instanceName+"$R"+(this._currentAutoCompleteSelectedIndex+1));if(a)this._resultsContainer.scrollTop=a.offsetTop}}},_addAbchElement:function AutoComplete$_addAbchElement(a,r,f){var k="",n="";if(a.isCategory||a.isGroup){k="<b>";n="</b>"}if(a._isNew){a._clientID=ContactPickerConstants.Constants.NONE;a._selectedElementID=a._clientID}if(a._uniqueSelectedElementID==0)a._uniqueSelectedElementID=++this._uniqueElementID;htmlIdForAbchElt=Microsoft.Live.ContactPicker.Util.concat(this._instanceName,"$",a._uniqueSelectedElementID);if(!a.isGroup&&!a.isCategory){var o=Microsoft.Live.ContactPicker.Util.htmlDecode(a.fullName),q=Microsoft.Live.ContactPicker.Util.htmlDecode(a.email);if(!ContactPickerCore.skipValidation)a.isValid=this._isInWhiteList(o,false)||this._validateEmail(q,htmlIdForAbchElt)}var d,e;if(!a.isValid){d="BlockInvalid";e=ContactPickerStrings.malformedContact}else{d="Block";e=""}var b="";if(f)b=Microsoft.Live.ContactPicker.Util.concat('<li class="',d,'" id="',htmlIdForAbchElt,'" title="',e,'">');if(a.isCategory&&(a._isNew||a.users.length>0))b+=Microsoft.Live.ContactPicker.Util.concat('<img class="ExpandCategory" alt="',ContactPickerStrings.expandCategory,'" title="',ContactPickerStrings.expandCategory,'" border="0" src="'+ContactPickerStrings.expandAcImg+"\" onclick=\"if(window.Control)Control.invoke('Microsoft.Live.ContactPicker.AutoComplete', '_doExpansion', event,{'id':",a._clientID,", 'UniqueSelectedElementID':",a._uniqueSelectedElementID,", 'FireEvent':true",", 'ExpandDuplicates':false",'})"/>');var l=!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a.email),g=!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a.fullName),p=l&&g?"BlockEmailWithName":"BlockEmailNoName";if(g)b+=Microsoft.Live.ContactPicker.Util.concat('<span class="BlockName">',k,a.fullName,n,"</span>");var j="",m="";if(g&&l){j="<span dir='ltr'>(</span>";m="<span dir='ltr'>)</span>"}if(!a.isCategory)b+=Microsoft.Live.ContactPicker.Util.concat('<span class="'+p+'">',j,a.email,m,"</span> ");var h=Microsoft.Live.ContactPicker.Util.concat('<img alt="{0}" title="{0}" border="0" src="{1}" ',"onclick=\"if(window.Control)Control.invoke('Microsoft.Live.ContactPicker.AutoComplete', '_editOrRemoveContactAndSetFocus', event, ","{'UniqueSelectedElementID':"+a._uniqueSelectedElementID+",'FireEvent':true,'IsEdit':{2}}",')"/>');if(AutoCompleteConfigs.EditEnabled&&!a.isCategory&&!a.isGroup)b+=String.format(h,ContactPickerStrings.editContact,ContactPickerStrings.editContactImg,true);b+=String.format(h,ContactPickerStrings.removeContact,ContactPickerStrings.deleteContactImg,false);if(f)b+="</li>";var i=this.selectedAbchElements.length;if(this._addAbchElementIndexOverride!=-1)i=this._addAbchElementIndexOverride;this.selectedAbchElements.splice(i,0,a);if(f)return b;else{this._reset();var c=document.createElement("li");c.className=d;c.id=htmlIdForAbchElt;c.title=Microsoft.Live.ContactPicker.Util.htmlDecode(e);c.innerHTML=b;this._inputUL.insertBefore(c,this._inputBoxLi);if(this._currentlyEditing())this._finishEditing()}if(r==true)setTimeout($CD(this,this._setInputFocus),50)},_editOrRemoveContactAndSetFocus:function AutoComplete$_editOrRemoveContactAndSetFocus(a){this._createElementFromInput(true);this._editOrRemoveContact(a);this._acCancelBubble()},_setInputFocus:function AutoComplete$_setInputFocus(){this._input.focus();if(this._browserType==ContactPickerConstants.Constants.SAFARI)this._inputDiv.scrollTop=this._input.offsetTop;if(this._input.createTextRange){var a=this._input.createTextRange();a.moveStart("character",this._input.value.length);a.collapse();a.select()}},_getContactEltByEmail:function AutoComplete$_getContactEltByEmail(a){a=Microsoft.Live.ContactPicker.Util.htmlEncode(a);a=a.toLowerCase();var g=a.charCodeAt(0),e=ContactPickerCore.searchIndex[g];if(!e)return null;for(var f=e.length;f--;){var h=e[f],b=new AbchElement(h),c=b._emailArray;if(!c)continue;for(var d=c.length;d--;)if(c[d].toLowerCase()==a){b.email=c[d];b.emailIndex=d;return b}}return null},_getContactRows:function AutoComplete$_getContactRows(b){var f=0,l=[];if(!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(b)){b=b.toLowerCase();var p=b.charCodeAt(0);b=Microsoft.Live.ContactPicker.Util.htmlEncode(b);var m=ContactPickerCore.searchIndex[p],c=[];if(m!=null){var q=m.length;for(var g=0;g<q;g++)c[g]=new AbchElement(m[g])}if(AutoCompleteConfigs.UsePicwData&&ContactPickerCore.picwEmailArray!=null&&ContactPickerCore.picwEmailArray.length>0)c=Microsoft.Live.ContactPicker.Util.mergePicwData(c,ContactPickerCore.picwEmailArray,true,p,null);regexEncodedFullSearchText=Microsoft.Live.ContactPicker.Util.escapeRegex(b);var t="(^|\\s)"+regexEncodedFullSearchText,r="^"+regexEncodedFullSearchText,s=c.length;for(var o=0;o<s;o++){var a=c[o],e=a.fullName,d=null;if(!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(e)){d=this._checkForMatch(t,e);if(d)e=this._emboldenMatch(d)}var i=a._emailArray;if(i&&i.length>0){var u=i.length;for(var j=0;j<u;j++){var k=i[j];if(!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(k)){var n=this._checkForMatch(r,k);if(n)k=this._emboldenMatch(n);if(d||n){var h=[];this._populateContactRow(h,++f,a._clientID,j,e,k,a.isSpacesFriend,a.isPicwOnly);l[f]=h.join("")}}}}else if(d){var h=[];this._populateContactRow(h,++f,a._clientID,0,e,null,a.isSpacesFriend,a.isPicwOnly);l[f]=h.join("")}}}this._resultRowCount=f;var v=l.join("");return v},_checkForMatch:function AutoComplete$_checkForMatch(b,a){var c=null;if(b!=null&&a!=null)try{regEx=new RegExp(b,"i");c=regEx.exec(a)}catch(d){}return c},_emboldenMatch:function AutoComplete$_emboldenMatch(a){var e=null;if(a!=null){var b=a.input,d=a[0],f=d.length,c=a.index;e=b.substr(0,c)+"<b>"+d+"</b>"+b.substr(c+f)}return e},_populateContactRow:function AutoComplete$_populateContactRow(a,n,m,k,c,b,h,l){if(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(c)&&!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(b))c=b;else if(!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(c)&&Microsoft.Live.ContactPicker.Util.isNullOrEmpty(b)&&h)b=Microsoft.Live.ContactPicker.Util.getPrivateMessageString();var g="ResultRow",f="",e="",d="</td>",i='<td class="PadderBorderRight">';if(this.synchResultsDropDownWidthToSearchBox){if(this._displayResultsInOneColumn)g="ResultRow ResultRowOneColumn";if(this._resultsDropDownContactNameWidth!="")e=Microsoft.Live.ContactPicker.Util.concat(' style="width:',this._resultsDropDownContactNameWidth,'"');if(this._resultsDropDownEmailWidth!="")f=Microsoft.Live.ContactPicker.Util.concat(' style="width:',this._resultsDropDownEmailWidth,'"');if(this._displayResultsInOneColumn){i="";d=""}}a[0]=Microsoft.Live.ContactPicker.Util.concat('<tr id="',this._instanceName,"$R",n,'"',' cid="',m,'" eid="',k,'" isPicwOnly="',l,'" class="',g,"\" onmouseover=\"if(window.Control)Control.invoke('Microsoft.Live.ContactPicker.AutoComplete', '_onResultHover', event, this)\" onmouseout=\"if(window.Control)Control.invoke('Microsoft.Live.ContactPicker.AutoComplete', '_onResultLeave', event, this)\"");a[1]=" onclick=\"if(window.Control)Control.invoke('Microsoft.Live.ContactPicker.AutoComplete', '_rowClickHandler', event)\">";a[2]=Microsoft.Live.ContactPicker.Util.concat('<td class="PadderBorderLeft"><div ',e,' class="ContactName">',c,"</div>",d);var j=h?' title="'+ContactPickerStrings.pmtt+'"':"";a[3]=Microsoft.Live.ContactPicker.Util.concat(i,"<div",j,f,' class="ContactEmail">',b?b:"&nbsp;","</div>",d);if(this._displayResultsInOneColumn)a[4]="</td></tr>";else a[4]="</tr>"},_onResultHover:function AutoComplete$_onResultHover(b){if(!b)return;$css.add(b,"Hover");var a=b.children;if(a)if(this._displayResultsInOneColumn)$css.add(a[0],"HoverBorderOneColumn");else{$css.add(a[0],"HoverBorderLeft");$css.add(a[1],"HoverBorderRight")}},_onResultLeave:function AutoComplete$_onResultLeave(b){if(!b)return;$css.remove(b,"Hover");var a=b.children;if(a)if(this._displayResultsInOneColumn)$css.remove(a[0],"HoverBorderOneColumn");else{$css.remove(a[0],"HoverBorderLeft");$css.remove(a[1],"HoverBorderRight")}},_acCancelBubble:function AutoComplete$_acCancelBubble(){event.cancelBubble=true;event.returnValue=false},_doExpansion:function AutoComplete$_doExpansion(d){this._acCancelBubble();var c=[],n=d["id"],o=d["UniqueSelectedElementID"],q=d["ExpandDuplicates"],f=new AbchElement(n),p=f.users.length,b,m=d["FireEvent"],i=this.selectedAbchElements.length;for(var a=0;a<i;a++){var g,j=this.selectedAbchElements[a];if(q)g=j._clientID==n;else g=j._uniqueSelectedElementID==o;if(g)for(var e=0;e<p;e++){b=new AbchElement(f.users[e]);b._selectedElementID=Microsoft.Live.ContactPicker.Util.concat(b._clientID,"-0");c.push(b)}else{b=this.selectedAbchElements[a];c.push(b)}}this._inputUL.innerHTML=this._inputULInitialContents;this._inputBoxLi=$(this._instanceName+"$InputBoxLi");this._input=$(this._instanceName+"$InputBox");this.selectedAbchElements=null;this.selectedAbchElements=[];var r=c.length,k=false;for(a=0;a<r;a++){var i=this.selectedAbchElements.length,l=false;if(!ContactPickerCore.allowDuplicateSelection)for(var h=0;h<i;h++)if(this.selectedAbchElements[h]._selectedElementID==c[a]._selectedElementID){l=true;break}if(!l){this._addAbchElement(c[a],false);k=true}}if(m&&k){this.Events.oncategoryexpand.fire([this,f]);m=false}this._persistState();setTimeout($CD(this,this._setInputFocus),50)},_onSearchIndexReady:function AutoComplete$_onSearchIndexReady(){if(!this._isReady)this._preselect();this._isReady=true;if(this._isWaitingOnReadyNotification){this._isWaitingOnReadyNotification=false;this._doSearch("")}if(this._pasteWhileInitializing)this._doPaste()},_isTypeElementMatch:function AutoComplete$_isTypeElementMatch(b,a){switch(b){case ContactPickerConstants.Constants.PEOPLE:if(!a.isCategory)return true;break;case ContactPickerConstants.Constants.FAVORITES:if(a.isFavorite)return true;break;case ContactPickerConstants.Constants.CATEGORIES:if(a.isCategory)return true}return false},hmAddElementsByString:function AutoComplete$hmAddElementsByString(){},_addElementsByString:function AutoComplete$_addElementsByString(d){if(!d)return;var g=new RegExp(this._emailPattern,"gi"),c=null,e=false;while((c=g.exec(d))!=null){var a=c[0];if(!a)continue;if(a.charAt(0)=="'"){var f=c!=null&&c.index>=0?c.index:d.indexOf(a);if(f!=-1)if(d.charAt(f+a.length)=="'")a=a.slice(1)}var b=this._getContactEltByEmail(a);if(!b){b=new AbchElement;b.email=Microsoft.Live.ContactPicker.Util.htmlEncode(a);b._clientID=ContactPickerConstants.Constants.NONE}this._addAbchElement(b,false);this._persistState();this._scrollInputToBottom();this.Events.oncontactadded.fire([this,b]);e=true}return e},_getBetween:function AutoComplete$_getBetween(c,e,d){var b,a,b=c.indexOf(e,0);if(b>-1){a=c.indexOf(d,b+1);if(a==-1||d=="")a=c.length}if(b>-1&&a>-1&&a>b)return c.substring(b+1,a);return ""},dispose:function AutoComplete$dispose(){Control.destroy(this);this._elt=null},setFocus:function AutoComplete$setFocus(){this._setInputWidth(this._input.value);setTimeout($CD(this,this._setInputFocus),50)},onContactAddedHandler:function AutoComplete$onContactAddedHandler(b){var c=b[0],a=b[1];a._selectedElementID=Microsoft.Live.ContactPicker.Util.concat(a._clientID,"-",a.emailIndex);this._addAbchElement(a,false);this._persistState();this._scrollInputToBottom()},onContactRemovedHandler:function AutoComplete$onContactRemovedHandler(c){var f=c[0],a=c[1],e=this.selectedAbchElements.length;if(a.email==null)a.email="";for(var d=e;d--;){var b=this.selectedAbchElements[d];if(b._clientID==a._clientID&&b.email==a.email)this._editOrRemoveContact({UniqueSelectedElementID:b._uniqueSelectedElementID,FireEvent:false,IsEdit:false})}this._persistState();this._scrollInputToBottom()},onAllDeselectedHandler:function AutoComplete$onAllDeselectedHandler(b){var f=b[0],e=b[1],d=this.selectedAbchElements.length;for(var c=d;c--;){var a=this.selectedAbchElements[c];if(a&&a._clientID!=ContactPickerConstants.Constants.NONE&&this._isTypeElementMatch(e,a))this._editOrRemoveContact({UniqueSelectedElementID:a._uniqueSelectedElementID,FireEvent:false,IsEdit:false})}this._persistState();this._scrollInputToBottom()},onAllSelectedHandler:function AutoComplete$onAllSelectedHandler(h){var k=h[0],j=h[1],f="",i=ContactPickerCore.contactData.length;for(var d=0;d<i;d++){var a=new AbchElement(d);if(!this._isTypeElementMatch(j,a))continue;if(a.isCategory)emailCount=1;else if(a._emailArray)emailCount=a._emailArray.length;if(emailCount)for(var c=0;c<emailCount;c++){var b=new AbchElement(d,c);if(!this._isAlreadySelected(b)){b._selectedElementID=Microsoft.Live.ContactPicker.Util.concat(b._clientID,"-",c);f+=this._addAbchElement(b,false,true)}delete b}else f+=this._addAbchElement(a,false,true)}var g=Microsoft.Live.ContactPicker.Util.concat(this._instanceName,"$InputBoxLi"),e=$(g);this._inputUL.removeChild(e);this._inputUL.innerHTML+=f;this._inputUL.appendChild(e);this._inputBoxLi=e;g=Microsoft.Live.ContactPicker.Util.concat(this._instanceName,"$InputBox");this._input=$(g);this._persistState();this._scrollInputToBottom()},associateControl:function AutoComplete$associateControl(a){this._onContactAddedDelegate=$CD(this,this.onContactAddedHandler);this._onContactRemovedDelegate=$CD(this,this.onContactRemovedHandler);this._onAllSelectedDelegate=$CD(this,this.onAllSelectedHandler);this._onAllDeselectedDelegate=$CD(this,this.onAllDeselectedHandler);a.Events.oncontactadded.attach(this._onContactAddedDelegate);a.Events.oncontactremoved.attach(this._onContactRemovedDelegate);a.Events.onallselected.attach(this._onAllSelectedDelegate);a.Events.onalldeselected.attach(this._onAllDeselectedDelegate);this._associatedControl=a},detachAssociatedCPEvents:function AutoComplete$detachAssociatedCPEvents(a){if(!this._onContactAddedDelegate)return;var a=this._associatedControl;a.Events.oncontactadded.detach(this._onContactAddedDelegate);a.Events.oncontactremoved.detach(this._onContactRemovedDelegate);a.Events.onallselected.detach(this._onAllSelectedDelegate);a.Events.onallselected.detach(this._onAllDeselectedDelegate)}};Microsoft.Live.ContactPicker.AutoComplete.createClass("Microsoft.Live.ContactPicker.AutoComplete");ComposeContactPicker={Events:{oncontactadded:new $Event,oncomposecontactpickerready:new $Event,onismanagedrestricted:new $Event}};ComposeContactPicker.acReady=false;ComposeContactPicker.anchorEltName="toBoxTo";ComposeContactPicker.cpDisabled=null;ComposeContactPicker.MAXFIELDLENGTH=2500;ComposeContactPicker.CpName="ContactPicker";ComposeContactPicker.toggleCPTo=function ComposeContactPicker$toggleCPTo(){ComposeContactPicker.anchorEltName="toBoxTo";ComposeContactPicker.toggleCP(ComposeContactPicker.autoCompleteTo)};ComposeContactPicker.toggleCPCc=function ComposeContactPicker$toggleCPCc(){ComposeContactPicker.anchorEltName="toBoxCc";ComposeContactPicker.toggleCP(ComposeContactPicker.autoCompleteCc)};ComposeContactPicker.toggleCPBcc=function ComposeContactPicker$toggleCPBcc(){ComposeContactPicker.anchorEltName="toBoxBcc";ComposeContactPicker.toggleCP(ComposeContactPicker.autoCompleteBcc)};ComposeContactPicker.toggleCP=function ComposeContactPicker$toggleCP(b){if(!ComposeContactPicker.acReady)return;var a=ComposeContactPicker.contactPicker;if(a==null)if(!ComposeContactPicker.isCpAcDisabled()){a=ComposeContactPicker.contactPicker=new Microsoft.Live.ContactPicker.ContactPicker(ComposeContactPicker.CpName);ComposeContactPicker.contactPicker.associateControl(ComposeContactPicker.autoCompleteTo);ComposeContactPicker._attachEvents()}else return;ComposeContactPicker.adjustCpHeight(0);if(a.isVisible==false)a.show();else if(ComposeContactPicker.activeAutoCompleteInstance==b)a.hide();else a.show();ComposeContactPicker.activeAutoCompleteInstance=b;ComposeContactPicker.positionContactPicker();a.reAssociateControl(b)};ComposeContactPicker.positionContactPicker=function ComposeContactPicker$positionContactPicker(){if($B.Safari)ComposePage._resizePage();if(ComposeContactPicker.activeAutoCompleteInstance==null)ComposeContactPicker.activeAutoCompleteInstance=ComposeContactPicker.autoCompleteTo;if(!ComposeContactPicker.contactPicker||!ComposeContactPicker.contactPicker.isVisible||!ComposeContactPicker.anchorEltName)return;setTimeout(ComposeContactPicker._positionCP,2)};ComposeContactPicker._positionCP=function ComposeContactPicker$_positionCP(){var b=$("CPAbsoluteContainer"),c=$(ComposeContactPicker.anchorEltName),a=b,e=ComposeContactPicker.getCoordinates(c);while(a!=null){a=a.offsetParent;if(a.currentStyle.position=="absolute")break}var d=$getLocation(a);ComposeContactPicker.anchorContactPicker(c,b,e,d)};ComposeContactPicker.anchorContactPicker=function ComposeContactPicker$anchorContactPicker(j,a,f,o){var c=f.left-o.left+(Loc.isBidi?j.offsetWidth:0),n=f.top-o.top+j.offsetHeight,d=Loc.isBidi?0:1,h=Loc.isBidi?0:1,e=document.body.clientWidth,i=document.body.clientHeight,b=5,p=a.children[0].clientWidth,q=a.children[0].clientHeight,l=Loc.isBidi?Math.abs(e-c)+p+b:f.left+p+b,k=f.top+q+b+j.offsetHeight;if(l>e||k>i){if(l>e){var m=l-e,r=Loc.isBidi?c+d+m+12:c+d-m-12;a.style.left=r+"px"}else a.style.left=c+d+"px";if(k>i){var m=k-i,g=n+h-m-15;if(g<0){ComposeContactPicker.adjustCpHeight(g-b);g=b}a.style.top=g+"px"}else a.style.top=n+h+"px"}else{a.style.top=n+h+"px";a.style.left=c+d+"px"}};ComposeContactPicker.adjustCpHeight=function ComposeContactPicker$adjustCpHeight(b){var e=$(ComposeContactPicker.CpName+"$Shadow"),d=$(ComposeContactPicker.CpName+"$PeopleListContainer"),h=$(ComposeContactPicker.CpName+"$CategoryListContainer"),i=$(ComposeContactPicker.CpName+"$FavoritesListContainer"),j=$(ComposeContactPicker.CpName+"$RecentListContainer"),g=d.parentNode,k=4,f=Microsoft.Live.ContactPicker.Util.getBrowser()==ContactPickerConstants.Constants.IE?parseInt(Resize.convertToPx(parseInt(e.currentStyle.height.replace("px",""))))-k:parseInt(e.currentStyle.height.replace("px","")),c=Microsoft.Live.ContactPicker.Util.getBrowser()==ContactPickerConstants.Constants.IE?parseInt(Resize.convertToPx(parseInt(d.currentStyle.height.replace("px","")))):parseInt(d.currentStyle.height.replace("px","")),a=ComposeContactPicker.contactPicker;if(a.cachedShadowHeight==null){a.cachedShadowHeight=f;a.cachedListHeight=c}if(b==0){a.isResized=false;e.style.height=Microsoft.Live.ContactPicker.Util.getBrowser()==ContactPickerConstants.Constants.IE?Resize.convertToEm(a.cachedShadowHeight)+"em":a.cachedShadowHeight+"px";d.style.height=Microsoft.Live.ContactPicker.Util.getBrowser()==ContactPickerConstants.Constants.IE?Resize.convertToEm(a.cachedListHeight)+"em":a.cachedListHeight+"px";h.style.height=Microsoft.Live.ContactPicker.Util.getBrowser()==ContactPickerConstants.Constants.IE?Resize.convertToEm(a.cachedListHeight)+"em":a.cachedListHeight+"px";i.style.height=Microsoft.Live.ContactPicker.Util.getBrowser()==ContactPickerConstants.Constants.IE?Resize.convertToEm(a.cachedListHeight)+"em":a.cachedListHeight+"px";j.style.height=Microsoft.Live.ContactPicker.Util.getBrowser()==ContactPickerConstants.Constants.IE?Resize.convertToEm(a.cachedListHeight)+"em":a.cachedListHeight+"px";g.style.height=d.style.height}else{if(a.isResized)return;if(c+b<=0||c+b<=75)b=-1*(c-75);a.isResized=true;e.style.height=f+b+"px";d.style.height=c+b+"px";h.style.height=c+b+"px";i.style.height=c+b+"px";j.style.height=c+b+"px";g.style.height=d.style.height}};ComposeContactPicker.getCoordinates=function ComposeContactPicker$getCoordinate(e){var b;if(Microsoft.Live.ContactPicker.Util.getBrowser()==ContactPickerConstants.Constants.IE){var a=e,c=0,d=0;while(a){if(a.currentStyle.position!="static"){c+=a.offsetLeft;d+=a.offsetTop}a=a.offsetParent}b={left:c,top:d}}else b=$getLocation(e);return b};ComposeContactPicker.copyEachToLineContents=function ComposeContactPicker$copyEachToLineContents(){ComposeContactPicker.transferEmailsToHiddenFields(ComposeContactPicker.autoCompleteTo,"fTo");ComposeContactPicker.transferEmailsToHiddenFields(ComposeContactPicker.autoCompleteCc,"fCc");ComposeContactPicker.transferEmailsToHiddenFields(ComposeContactPicker.autoCompleteBcc,"fBcc")};ComposeContactPicker.safeHtmlDecode=function ComposeContactPicker$safeHtmlDecode(a){if(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a))return a;return a.decodeHtml()};ComposeContactPicker.getValue=function ComposeContactPicker$getValue(f){var h=f.selectedAbchElements.length,g="",a="";for(var e=0;e<h;e++){var b=f.selectedAbchElements[e],a="",d,c=ComposeContactPicker.safeHtmlDecode(b.fullName).replace(/"/g,"");if(b.isCategory||b.isGroup)a=Microsoft.Live.ContactPicker.Util.concat('"',c,'";');else{d=ComposeContactPicker.safeHtmlDecode(b.email);if(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(d))a=Microsoft.Live.ContactPicker.Util.concat(a,c,";");else a=Microsoft.Live.ContactPicker.Util.concat(a,'"',c,'" <',d,">;")}g+=a}return g};ComposeContactPicker.transferEmailsToHiddenFields=function ComposeContactPicker$transferEmailsToHiddenFields(c,b){var a=$(b);if(a)a.value=ComposeContactPicker.getValue(c)};ComposeContactPicker.populateReply=function ComposeContactPicker$populateReply(d,a){var b=$(d).value;if(b!=""){a.hmAddElementsByString(b);if(a._input.setSelectionRange){var c=a._input.value.length;a._input.setSelectionRange(c,c)}}};ComposeContactPicker.sendMessagePrep=function ComposeContactPicker$sendMessagePrep(a){if(!ComposeContactPicker.acReady)return;ComposeContactPicker.completeACEntries();ComposeContactPicker.copyEachToLineContents();if(a)ComposeContactPicker._instrumentContactPicker()};ComposeContactPicker.completeACEntries=function ComposeContactPicker$completeACEntries(){if(!ComposeContactPicker.acReady)return;ComposeContactPicker.autoCompleteTo.completeFreeFormEmail();ComposeContactPicker.autoCompleteCc.completeFreeFormEmail();ComposeContactPicker.autoCompleteBcc.completeFreeFormEmail()};ComposeContactPicker._instrumentContactPicker=function ComposeContactPicker$_instrumentContactPicker(){if(ComposeContactPicker.contactPicker&&ComposeContactPicker.contactPicker.contactPickerUsed)$BSI.reportEvent("cp.addContact",null)};ComposeContactPicker.isCpAcDisabled=function ComposeContactPicker$isCpAcDisabled(){if(ComposeContactPicker.cpDisabled==null){var c=$("fTo"),b=$("fCc"),a=$("fBcc");if(c.value.length>=ComposeContactPicker.MAXFIELDLENGTH||b.value.length>=ComposeContactPicker.MAXFIELDLENGTH||a.value.length>=ComposeContactPicker.MAXFIELDLENGTH)ComposeContactPicker.cpDisabled=true;else ComposeContactPicker.cpDisabled=false}return ComposeContactPicker.cpDisabled};ComposeContactPicker.cpFocusOutHandler=function ComposeContactPicker$cpFocusOutHandler(){var a=event.toElement,d=$("CPAbsoluteContainer"),g=$("toBtn"),f=$("ccBtn"),e=$("bccBtn"),c=false,b=a;while(b!=null){if(b==d){c=true;break}b=b.parentNode}if(a==g||a==f||a==e)return;if(a==null||!c)if(ComposeContactPicker.contactPicker)ComposeContactPicker.contactPicker.hide()};ComposeContactPicker.instantiateContactPickerControls=function ComposeContactPicker$instantiateContactPickerControls(){if(ComposeContactPicker.isCpAcDisabled())return;var a=ComposeContactPicker;try{Microsoft.Live.ContactPicker.AutoComplete.prototype.hmAddElementsByString=a.hmAddElementsByString;Microsoft.Live.ContactPicker.AutoComplete.prototype._addByKnownFormat=a._addByKnownFormat;a.autoCompleteTo=new Microsoft.Live.ContactPicker.AutoComplete("AutoCompleteTo");a.autoCompleteCc=new Microsoft.Live.ContactPicker.AutoComplete("AutoCompleteCc");a.autoCompleteBcc=new Microsoft.Live.ContactPicker.AutoComplete("AutoCompleteBcc");var f=a.autoCompleteTo,e=a.autoCompleteCc,d=a.autoCompleteBcc;f.synchResultsDropDownWidthToSearchBox=true;e.synchResultsDropDownWidthToSearchBox=true;d.synchResultsDropDownWidthToSearchBox=true;f.wasclVerifyRecipient=a._BeginVerifyRecipient;e.wasclVerifyRecipient=a._BeginVerifyRecipient;d.wasclVerifyRecipient=a._BeginVerifyRecipient;f.Events.onismanagedrestricted.attach(isManagedAccountRemovedContact);e.Events.onismanagedrestricted.attach(isManagedAccountRemovedContact);d.Events.onismanagedrestricted.attach(isManagedAccountRemovedContact);var b=ComposeContactPicker.positionContactPicker;f.Events.oncontactadded.attach(b);f.Events.oncontactremoved.attach(b);e.Events.oncontactadded.attach(b);e.Events.oncontactremoved.attach(b);d.Events.oncontactadded.attach(b);d.Events.oncontactremoved.attach(b);var j=$("CPAbsoluteContainer");if(j)j.attachEvent("onfocusout",ComposeContactPicker.cpFocusOutHandler)}catch(p){return}ComposeContactPicker.acReady=true;var c=null,i=document.activeElement,n=$("fTo"),m=$("fCc"),l=$("fBcc");if(n&&i==n)c=ComposeContactPicker.autoCompleteTo;if(m&&i==m)c=ComposeContactPicker.autoCompleteCc;if(l&&i==l)c=ComposeContactPicker.autoCompleteBcc;var k=["To","Cc","Bcc"];for(var h=1;h<=3;h++){var g=$("noJsToBox"+k[h-1]),o=$("toBox"+k[h-1]);if(g){g.style.width="0px";g.style.height="0px";g.style.border="none"}if(o)$setDisplay(o,true)}if(c){c.setFocus();setTimeout(ComposeContactPicker._finalizeFocusTransfer,0)}else ComposeContactPicker._finalizeFocusTransfer()};ComposeContactPicker._finalizeFocusTransfer=function ComposeContactPicker$__finalizeFocusTransfer(){ComposeContactPicker._populateAcFields();$setDisplay($("noJsToBoxTo"),false);$setDisplay($("noJsToBoxCc"),false);$setDisplay($("noJsToBoxBcc"),false)};ComposeContactPicker._populateAcFields=function ComposeContactPicker$_populateAcFields(){ComposeContactPicker.populateReply("fTo",ComposeContactPicker.autoCompleteTo);ComposeContactPicker.populateReply("fCc",ComposeContactPicker.autoCompleteCc);ComposeContactPicker.populateReply("fBcc",ComposeContactPicker.autoCompleteBcc)};ComposeContactPicker._attachEvents=function ComposeContactPicker$_attachEvents(){if(!ComposeContactPicker.isCpAcDisabled()&&ComposeContactPicker.contactPicker!=null){var b=ComposeContactPicker.contactPicker,a=ComposeContactPicker.positionContactPicker;b.Events.oncontactadded.attach(a);b.Events.oncontactremoved.attach(a);b.Events.onallselected.attach(a);b.Events.onalldeselected.attach(a)}this.Events.oncomposecontactpickerready.fire([this,{}])};ComposeContactPicker._addByKnownFormat=function(r){var b=r;if(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(b))return false;var h=new RegExp('"[^"]*"( <[^>]*>)?',"gi"),e=h.exec(b);if(!e)return false;h=new RegExp('"[^"]*"',"i");e=h.exec(b);var i=b.substring(e[0].length),s=new RegExp(this._emailPattern,"gi"),d=s.exec(e!=null?i:b),a=null;if(d){var c=d[0];if(c.charAt(0)=="'"){var l=d!=null&&d.index>=0?d.index:i.indexOf(c);if(l!=-1)if(i.charAt(l+c.length)=="'")c=c.slice(1)}a=this._getContactEltByEmail(c);if(!a){if(ContactPickerCore.isManagedRestricted){this.Events.onismanagedrestricted.fire([this,null]);return false}a=new AbchElement;a.email=Microsoft.Live.ContactPicker.Util.htmlEncode(c);a._clientID=ContactPickerConstants.Constants.NONE}}else{var g=b.split('"'),p=g.length,m="";if(p>1){var o=g[1].toLowerCase().charCodeAt(0);m=Microsoft.Live.ContactPicker.Util.htmlEncode(g[1]);var f=ContactPickerCore.searchIndex[o];if(f)for(var n=f.length;n--;){var q=f[n],k=new AbchElement(q),j=k.fullName;if(!j||j=="")continue;if(j==m){a=k;break}}}if(!a&&this._isInWhiteList(b,false)){a=new AbchElement;a.fullName=Microsoft.Live.ContactPicker.Util.htmlEncode(b)}}if(a){this._addAbchElement(a,false);this._persistState();this._scrollInputToBottom();this.Events.oncontactadded.fire([this,a]);return true}return false};ComposeContactPicker.hmAddElementsByString=function(g){if(Microsoft.Live.ContactPicker.Util.isNullOrEmpty(g))return;var h=g.split(";"),j=h.length,n=1,b="";for(var f=0;f<j;f++){var e=h[f],a=e;if(!this._addByKnownFormat(e)){var k=new RegExp(this._emailPattern,"gi"),i=null,m=false,l="";while((i=k.exec(e))!=null){var d=i[0];if(d){this._addElementsByString(d);a=a.replace(d,"");a=a.replace(/^[ \t]+/,"")}}var c=a.replace(/[ \t]+$/,"");if(c.length>0)b+=b==""?c:" "+c}}this.populateInput(b)};ComposeContactPicker._unencodedEmails=[];ComposeContactPicker._htmlIds=[];ComposeContactPicker._verifyTimer=0;ComposeContactPicker._pendingVerifyResponse=false;ComposeContactPicker._verifyTimeout=0;ComposeContactPicker._BeginVerifyRecipient=function(b,a){if(!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(b)&&!Microsoft.Live.ContactPicker.Util.isNullOrEmpty(a)){ComposeContactPicker._unencodedEmails.push(b);ComposeContactPicker._htmlIds.push(a);if(!ComposeContactPicker._pendingVerifyResponse){if(ComposeContactPicker._verifyTimer!=0)clearTimeout(ComposeContactPicker._verifyTimer);ComposeContactPicker._verifyTimer=setTimeout(ComposeContactPicker._BeginVerifyRecipientsFPP,ComposeContactPicker._verifyTimeout)}}return true};ComposeContactPicker._BeginVerifyRecipientsFPP=function(){HM.LFPP=function(){HM.VerifyRecipients(ComposeContactPicker._unencodedEmails,ComposeContactPicker._EndVerifyRecipientsFPP,{htmlIds:ComposeContactPicker._htmlIds})};HM.LFPP();ComposeContactPicker._unencodedEmails=[];ComposeContactPicker._htmlIds=[];ComposeContactPicker._verifyTimer=0;ComposeContactPicker._pendingVerifyResponse=true};ComposeContactPicker._EndVerifyRecipientsFPP=function(b,e){ComposeContactPicker._pendingVerifyResponse=false;if(b!=null){var c=e.htmlIds,d=c.length;for(var a=0;a<d;a++)if(b[a]==false)Microsoft.Live.ContactPicker.AutoComplete.prototype.markContactAsInvalid(c[a])}if(ComposeContactPicker._unencodedEmails.length>0||ComposeContactPicker._htmlIds.length>0)ComposeContactPicker._verifyTimer=setTimeout(ComposeContactPicker._BeginVerifyRecipientsFPP,ComposeContactPicker._verifyTimeout)};Type.createStaticClass(ComposeContactPicker,"ComposeContactPicker");ExpandCollapse={};ExpandCollapse.initializeForStandaloneUi=function ExpandCollapse$initializeForStandaloneUi(){var a=$("folderList");if(a)a.attachEvent("onclick",function(){ExpandCollapse.onClick(App.config.excoCookieValFl)});var b=$("quickViewList");if(b)b.attachEvent("onclick",function(){ExpandCollapse.onClick(App.config.excoCookieValQv)})};ExpandCollapse.onClick=function ExpandCollapse$onClick(a){ExpandCollapse.handleClick(event.srcElement,a)};ExpandCollapse.handleClick=function ExpandCollapse$handleClick(e,d){var c=Control.getAncestorByAttr(e,"exco_hot");if(c){var a=Control.getAncestorByAttr(c,"exco_main");if(a){var b=$css.has(a,"exco_disabled");if(b)$css.remove(a,"exco_disabled");else $css.add(a,"exco_disabled");ExpandCollapse._updateCookie(d,!b);if(Page.getLayout().indexOf("Unmanaged")>=0&&UnmanagedFooter)UnmanagedFooter.resize()}}};ExpandCollapse._updateCookie=function ExpandCollapse$_updateCookie(b,d){var a=$Cookie.getCookieValues(App.config.pdCookie),c=d?"1":"0";if(a[b]!=c){a[b]=c;$Cookie.setCookieValues(App.config.pdCookie,a,$Cookie.getPermanentExpirationDate())}};$MenuCog={};$MenuCog.onBindOpen=function $MenuCog$onBindOpen(a){$MenuCog.changeCogClass(a,true)};$MenuCog.onClose=function $MenuCog$onClose(a){if(a&&a.menu&&!a.menu.isOpen())$MenuCog.changeCogClass(a,false)};$MenuCog.changeCogClass=function $MenuCog$changeCogClass(d,c){var b=$getDescendantByClass(d,"img","MenuCog");if(b)c?$css.add(b,"CogMenuOn"):$css.has(b,"CogMenuOn")&&$css.remove(b,"CogMenuOn");var a=$getNearestParentByClass(d,"lnav_topItem");if(a)c?$css.add(a,"MenuOn"):$css.has(a,"MenuOn")&&$css.remove(a,"MenuOn")};ComposePage.initializeBucket2=function ComposePage$initializeBucket2(){ComposePage.attachmentList=new AttachmentUpload($("fAttachments"));ComposePage.attachmentList.Events.onuienabled.attach(ComposePage.attachUIEnabled);setTimeout(Resize._resizeComposeHeader,1);ComposeContactPicker.Events.oncomposecontactpickerready.attach($CD(this,ComposePage._onComposeContactPickerReady));ComposeContactPicker.instantiateContactPickerControls();if(ComposePage.RTE&&ComposePage.RTE.rte)ComposePage.spellChecker=new SpellChecker(ComposePage.RTE.rte,ComposePage.isDraft);if(window.ExpandCollapse)ExpandCollapse.initializeForStandaloneUi();if(ComposePage.bucket3Script)window.setTimeout(function(){ComposePage.downloadBucket3()},20);else Page.pageComplete()};ComposePage.downloadBucket3=function ComposePage$downloadBucket3(){Loader.load(ComposePage.bucket3Css,ComposePage.bucket3Script,ComposePage.onBucket3Download,$("bucket3"))};ComposePage.onBucket3Download=function ComposePage$onBucket3Download(){ComposePage.initializeBucket3()};ComposePage._onComposeContactPickerReady=function ComposePage$_onComposeContactPickerReady(){ComposePage.initialState.fTo=ComposeContactPicker.getValue(ComposeContactPicker.autoCompleteTo);ComposePage.initialState.fCc=ComposeContactPicker.getValue(ComposeContactPicker.autoCompleteCc);ComposePage.initialState.fBcc=ComposeContactPicker.getValue(ComposeContactPicker.autoCompleteBcc)};ComposePage.addAttachment=function ComposePage$addAttachment(a){if(ComposePage.attachmentList!=null)ComposePage.attachmentList.addAttachment(a);setTimeout(function(){ComposePage.dontWarn=false},0)};ComposePage.attachUIEnabled=function ComposePage$attachUIEnabled(){setTimeout(Resize._resizeComposeHeader,50)};if(!Browser.isIE)ComposePage.downloadBucket3=function ComposePage$downloadBucket3(){Loader.load(ComposePage.bucket3Css,ComposePage.bucket3Script,ComposePage.onBucket3Download)}
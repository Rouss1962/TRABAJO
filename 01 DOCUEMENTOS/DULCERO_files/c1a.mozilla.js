if(!window.RTE)window.RTE={};RTE.Editor=function RTE$Editor(a){Control.create(this,a);this.Events={onrteready:new $Event,onbeforepropertychange:new $Event,onpropertychange:new $Event,onexeccommand:new $Event,onselectionchange:new $Event,ontextchange:new $Event};this._plainText=a.getElementsByTagName("textarea")[0];this._mode=RTE.Mode[a.getAttribute("mode")];this._isRTEMode=this._mode==RTE.Mode.RichText;if($tag(this.elt,"IFRAME")[0].getAttribute("frameready")=="yes")this.setMode(this._mode);this._initializeEditor()};RTE.Editor.prototype={elt:null,_toolbar:null,_editor:null,_mode:null,_isRTEMode:false,_onSelChangeHandler:null,dispose:function RTE$dispose(){this._document.detachEvent("onselectionchange",this._onSelChangeHandler);this.elt.detachEvent("onkeyup",this._onSelChangeHandler);this.elt.detachEvent("onbeforedeactivate",this._onBeforeFocusOut);Control.destroy(this)},isRTEMode:function RTE$isRTEMode(){return this._isRTEMode},_initializeEditor:function RTE$IE$_initializeEditor(){var a=$tag(this.elt,"IFRAME")[0];this._editor=this._rte=a;this._frameReady=a.getAttribute("frameready")=="yes";if(!this._frameReady){this._frameData={display:this._isRTEMode,focus:false};a.attachEvent("onload",function(){RTE.turnOn(a)})}this._doInit()},_doInit:function RTE$_doInit(){this._iframe=$tag(this.elt,"IFRAME")[0];if(this._iframe.getAttribute("frameready")=="no")return;this._window=this._iframe.contentWindow;this._document=this._window.document;this._editor=this._document.body;if(this._iframe.title)this._document.title=this._iframe.title;$updateClass(this._editor,[this.elt.getAttribute("mode")],RTE.ModeStrings);if(!this._frameReady){this._frameReady=true;if(this._frameData.focus)this.focus();this._frameData=null}this._onSelChangeHandler=$CD(this,this._detectSelectionChange);this._document.attachEvent("onselectionchange",this._onSelChangeHandler);this._doInitImpl();this._fireOnReady()},_doInitImpl:function RTE$IE$_doInitImpl(){this._onBeforeDeactivateHandler=$CD(this,this._onBeforeFocusOut);this._onBeforePasteHandler=$CD(this,this._onBeforePaste);this._onPasteHandler=$CD(this,this._onPaste);this.elt.attachEvent("onkeyup",this._onSelChangeHandler);this.elt.attachEvent("onbeforedeactivate",this._onBeforeDeactivateHandler);this._editor.attachEvent("onbeforepaste",this._onBeforePasteHandler);this._editor.attachEvent("onpaste",this._onPasteHandler)},_onBeforeFocusOut:function RTE$IE$_onBeforeFocusOut(){this._lastGoodSelection=this._getCurrentRange()},_onBeforePaste:function RTE$onBeforePaste(a){a.returnValue=false},_onPaste:function RTE$_onPaste(a){if(this.getMode()!=RTE.Mode.RichText){a.returnValue=false;this.setSelection(clipboardData.getData("Text"))}},_fireOnReady:function RTE$fireOnReady(){this.elt.setAttribute("ready","1");var a=this;setTimeout(function(){a.Events.onrteready.fire([a])},1)},_alertConversionError:function RTE$_alertConversionError(){alert(RTE.Editor.getString("RTE.Editor.ConversionError"))},_updateRTEEditor:function RTE$_updateRTEEditor(c,b){if(c==b)return;var a="";switch(b){case RTE.Mode.RichText:if(c==RTE.Mode.PlainText)this._editor.innerHTML=RTE.ConvertToPlainText(this._editor.innerHTML,true);else try{this._editor.innerHTML=this._editor.innerText}catch(d){this._alertConversionError();return}a=RTE.ModeStrings[RTE.Mode.RichText];break;case RTE.Mode.HTML:try{this._editor.innerHTML=RTE.Editor.PrettyPrint(this._editor.innerHTML)}catch(d){this._alertConversionError();return}a=RTE.ModeStrings[RTE.Mode.HTML];break;case RTE.Mode.PlainText:try{if(c==RTE.Mode.HTML)this._editor.innerHTML=this._editor.innerText;this._editor.innerHTML=RTE.ConvertToPlainText(this._editor.innerHTML,true)}catch(d){this._alertConversionError();return}a=RTE.ModeStrings[RTE.Mode.PlainText];break;default:return}$updateClass(this._editor,[a],RTE.ModeStrings);this.elt.setAttribute("mode",a);this._mode=b;this._isRTEMode=b==RTE.Mode.RichText},_isSwapping:false,setMode:function RTE$setMode(b){var a=this.getMode();this._isSwapping=true;if(a!=b)this.Events.onbeforepropertychange.fire([this,{property:"mode",from:a,to:b}]);this._updateRTEEditor(a,b);RTE.Sync(this.elt);this._isSwapping=false;if(a!=this.getMode())this.Events.onpropertychange.fire([this,{property:"mode",from:a,to:b}]);this._lastGoodSelection=null},getMode:function RTE$getMode(){return this._mode},queryCommandValue:function RTE$IE$queryCommandValue(b,a){return this._document.queryCommandValue(a)},queryCommandState:function RTE$IE$queryCommandState(b,a){return this._document.queryCommandState(a)},queryCommandSupported:function RTE$IE$queryCommandSupported(b,a){return this._document.queryCommandSupported(a)},execCommand:function RTE$execCommand(c,a,d){var b=false;if(this.queryCommandSupported(c,a)){c.select();this._document.execCommand(a,false,d);b=true}this.Events.onexeccommand.fire([this,{range:c,command:a,value:d,handled:b}]);return b},attachRTEEvent:function RTE$FF$attachRTEEvent(b,a){var c=this._window;a._rteHandler=function(){return a(c.event)};this._document.attachEvent(b,a._rteHandler)},detachRTEEvent:function RTE$FF$detachRTEEvent(b,a){this._document.detachEvent(b,a._rteHandler)},getSelection:function RTE$getSelection(b){var a=this._getSelectionImpl();if(b=="all"){a.moveToElementText(this._getRTEElement());return a.parentElement()}return a},_lastGoodSelection:null,_getSelectionImpl:function RTE$IE$_getSelectionImpl(){var a=this._getCurrentRange();if(!this._isRangeWithinRTE(a)){if(!this._lastGoodSelection){try{a.moveToElementText(this._editor)}catch(b){a=this._editor.createTextRange()}a.collapse(true);this._lastGoodSelection=a}return this._lastGoodSelection}this._lastGoodSelection=a;return a},_getCurrentRange:function RTE$IE$getCurrentRange(){var a;try{a=this._document.selection.createRange()}catch(b){a=this._editor.createTextRange();a.collapse(true)}return a},getCurrentSelectionType:function RTE$getCurrentSelectionType(){return this._document.selection.type},setSelection:function RTE$setSelection(b){var a=this.getSelection();try{this._isRTEMode?a.pasteHTML(b):(a.text=b);a.select()}catch(c){return}},_isRangeWithinRTE:function RTE$IE$_isRangeWithinRTE(a){try{var b=a.commonParentElement?a.commonParentElement():a.parentElement();return this._editor.contains(b)||this._editor==b}catch(c){return false}},_detectSelectionChange:function RTE$IE$detectSelectionChange(){var a=null;try{a=this._document.selection.createRange()}catch(b){return}if(a.length)return;this.Events.onselectionchange.fire([this,{range:a}]);this.Events.ontextchange.fire([this,{}])},getValue:function RTE$getValue(){var a=this._isRTEMode?this._editor.innerHTML:RTE.ConvertToPlainText(this._editor.innerHTML);RTE.Sync(this.elt);return a},setValue:function RTE$setValue(a){this._editor.innerHTML=this._mode==RTE.Mode.RichText?a:RTE.Editor.HTMLEncode(a,true);RTE.Sync(this.elt)},focus:function RTE$IE$focus(){if(!this._frameReady){this._frameData.focus=true;return}var a=this._window;$callFocus(a);this._isRTEMode&&this._detectSelectionChange()},insertContent:function RTE$insertContent(a){this.setSelection(a)}};RTE._CloseHTMLTags=function RTE$_CloseHTMLTags(c){var a=document.createElement("div");a.innerHTML=c;var b=a.innerHTML;a=null;return b};RTE.Editor.getString=function RTE$Editor$getString(a){return decodeURIComponent(RTE_STRINGS[a])};RTE.Editor.PrettyPrint=function RTE$PrettyPrint(a){return RTE.Editor.HTMLEncode(a,true).replace(/&lt;br&gt;/ig,"&lt;br&gt;<br>").replace(/&lt;\/p&gt;/ig,"&lt;/p&gt;<br>").replace(/&lt;\/div&gt;/ig,"&lt;/div&gt;<br>")};RTE.Editor.HTMLEncode=function RTE$IE$HTMLEncode(b,c){if(b==null)return "";var a=b.encodeHtml();return c?a.replace(/\r\n|&#13;&#10;|\n|&#10;/g,"<BR>"):a.replace(/<BR>/g,"\r\n")};RTE.Editor.getFontSizes=function RTE$Editor$getFontSizes(){return RTE.Editor.getFontAttribs(RTE_CONFIG.FONT_SIZE)};RTE.Editor.getFontNames=function RTE$Editor$getFontNames(){return RTE.Editor.getFontAttribs(RTE_CONFIG.FONT_NAME)};RTE.Editor.getFontAttribs=function RTE$Editor$getFontAttribs(a){for(var b=a.length-1;b>=0;b--)a[b]=decodeURIComponent(a[b]);return a};RTE.Editor.createClass("RTE.Editor");RTE._CODE_READY=true;RTE._CODE_READY=false;if(Browser.isSF){RTE.Editor.prototype._doInitImpl=function RTE$SF$_doInitImpl(){var a=window.getSelection();if(""!=a)a.collapse(this._editor,0);this._editor.addEventListener("keydown",this._onSelChangeHandler,false);this._document.execCommand("styleWithCSS",false,false);this._onNodeInsertedHandler=$CD(this,this._onNodeInserted);this._editor.addEventListener("DOMNodeInserted",this._onNodeInsertedHandler,false);this._editor.addEventListener("DOMAttrModified",this._onNodeInsertedHandler,false)};RTE.Editor.prototype._onNodeInserted=function RTE$SF$_onNodeInserted(d){var c=d.srcElement;if("SPAN"==c.tagName){fontSize=c.style.fontSize;if(null==fontSize||""==fontSize||fontSize.indexOf("pt")>=0||fontSize.indexOf("px")>=0)return;var b=RTE.Editor.getFontSizes(),a=RTE_CONFIG.DEFAULT_FONT_SIZE;switch(fontSize){case "x-small":a=b[0];break;case "small":a=b[1];break;case "medium":a=b[2];break;case "large":a=b[3];break;case "x-large":a=b[4];break;case "xx-large":a=b[5];break;case "-webkit-xxx-large":a=b[6]}c.style.fontSize=a}};RTE.Editor.prototype.focus=function RTE$SF$focus(){this._editor.focus();var a=window.getSelection();a.collapse(this._editor,0)}}if(Browser.isFF){RTE.Editor.prototype._doInitImpl=function RTE$FF$_doInitImpl(){this._onNodeInsertedHandler=$CD(this,this._onNodeInserted);this._editor.addEventListener("DOMNodeInserted",this._onNodeInsertedHandler,false);this._editor.addEventListener("DOMAttrModified",this._onNodeInsertedHandler,false);this._document.execCommand("styleWithCSS",false,false)};RTE.Editor.prototype._getSelectionImpl=function RTE$FF$_getSelectionImpl(){return this._document.selection.createRange()};RTE.Editor.prototype.queryCommandValue=function RTE$FF$queryCommandValue(b,a){return b.queryCommandValue(a)};RTE.Editor.prototype.queryCommandState=function RTE$FF$queryCommandState(b,a){return b.queryCommandState(a)};RTE.Editor.prototype.queryCommandSupported=function RTE$FF$queryCommandSupported(b,a){return b.queryCommandSupported(a)};RTE.Editor.prototype._onNodeInserted=function RTE$FF$_onNodeInserted(b){var a=b.srcElement;if(a.tagName=="FONT"){var c=a.getAttribute("size");a.style.fontSize=RTE.Editor.getFontSizes()[c-1]}};RTE.Editor.HTMLEncode=function RTE$FF$HTMLEncode(b,c){var a="";if(b!=null){a=b.encodeHtml();if(c)a=a.replace(/\r\n|&#13;&#10;|\n|&#10;/g,"<BR>")}return a}}RTE.Editor.createClass("RTE.Editor");RTE._CODE_READY=true;Type.registerNamespace("RTE");RTE.Control=function RTE$Control(a){Control.create(this,a);this.Events={onpropertychange:new $Event};this.rte=new RTE.Editor($tag(a,"IFRAME")[0].parentNode);this._onSelChangeHandler=$CD(this,this._rte_onSelectionChange);this.rte.Events.onrteready.attach($CD(this,this._rte_onRTEReady));this._toolbar=new ButtonList($tag(a,"UL")[0].parentNode);this._toolbar.setEnabled(true);this._toolbar.Events.onbuttonclick.attach($CD(this,this._toolbar_onClick))};RTE.Control.prototype={elt:null,rte:null,dispose:function RTE$Control$dispose(){Menu.Destroy(this._modeMenuElt);Menu.Destroy(this._fsMenuElt);Menu.Destroy(this._fnMenuElt);Hyperlink.Destroy(this._clElt);ColorPicker.Destroy(this._cpElt);Control.destroy(this);this._disposeMenu();this.rte.dispose()},_rte_onRTEReady:function RTE$_onRTEReady(){this._cpElt=ColorPicker.Create();this._clElt=Hyperlink.Create();var c=RTE.Editor.getFontNames(),b=[],e=c.length;for(var a=0;a<e;a++)b.push({key:c[a],caption:c[a]});this._fnMenuElt=Menu.Create(b);b=[];var d=RTE.Editor.getFontSizes(),e=d.length;for(var a=0;a<e;a++)b.push({key:a+1,caption:parseInt(d[a])});this._fsMenuElt=Menu.Create(b);this._fsMenuElt.style.width=Resize.convertToEm(this._toolbar.getButtonProperty("showFontSizes","elt").offsetWidth)+"em";b=[{key:RTE.ModeStrings[RTE.Mode.RichText],caption:RTE.Control.getString("RTE.Mode.RichText"),tooltip:RTE.Control.getString("RTE.Mode.RichText.Tooltip")},{key:RTE.ModeStrings[RTE.Mode.HTML],caption:RTE.Control.getString("RTE.Mode.HTML"),tooltip:RTE.Control.getString("RTE.Mode.HTML.Tooltip")},{key:RTE.ModeStrings[RTE.Mode.PlainText],caption:RTE.Control.getString("RTE.Mode.PlainText"),tooltip:RTE.Control.getString("RTE.Mode.PlainText.Tooltip")}];this._modeMenuElt=Menu.Create(b);if(Browser.isIE)this._createDropDownHTML();this._keyPressHandler=$CD(this,this._rte_onKeyPress);this._keyDownHandler=$CD(this,this._rte_onKeyDown);this.rte.attachRTEEvent("onkeypress",this._keyPressHandler);this.rte.attachRTEEvent("onkeydown",this._keyDownHandler);this.rte.Events.onexeccommand.attach($CD(this,this._rte_onExecCommand));this.rte.Events.onpropertychange.attach($CD(this,this._rte_onPropertyChange));this._onSelChangeHandler=$CD(this,this._rte_onSelectionChange);this.rte.Events.onselectionchange.attach(this._onSelChangeHandler)},_createDropDownHTML:function RTE$_createDropDownHTML(){var h=$tag(this._toolbar.getButtonProperty("showFontNames","elt"),"A")[0],f='<span unselectable="on" class="c_chev">&#9660;</span>',c=RTE.Editor.getFontNames(),a=[],e=c.length,g=this.elt.getAttribute("fontname");for(var b=0;b<e;b++)a.push(String.format('<span unselectable="on" class="caption" style="display:{1}">{0}</span>',c[b],c[b]==g?"block":"none"));a.push('<span class="caption" style="display:none">&nbsp;</span>');a.push(f);h.innerHTML=a.join("");var h=$tag(this._toolbar.getButtonProperty("showFontSizes","elt"),"A")[0],d=RTE.Editor.getFontSizes();a=[];e=d.length;var g=parseInt(this.elt.getAttribute("fontsize"));for(var b=0;b<e;b++)a.push(String.format('<span unselectable="on" class="caption" style="display:{1};">{0}</span>',parseInt(d[b]),parseInt(d[b])==g?"block":"none"));a.push('<span unselectable="on" class="caption" style="display:none">&nbsp;</span>');a.push(f);h.innerHTML=a.join("")},_rte_onKeyPress:function RTE$IE$_rte_onKeyPress(){},_rte_onKeyDown:function RTE$IE$_rte_onKeyDown(a){if(Browser.isIE&&a.keyCode==8&&this.rte.getCurrentSelectionType()=="Control"){a.cancelBubble=true;var b=this.rte.getSelection();this.rte.execCommand(b,"delete",null)}},_rte_onPropertyChange:function RTE$_rte_onPropertyChange(b){var d=b[0],a=b[1];if(a.property=="mode"){this._setToolbarEnabled(a.to==RTE.Mode.RichText);var c=this.getModeKey(a.to);if(this._toolbar.containsButtonKey("showModes"))this._toolbar.setButtonProperty("showModes","text",RTE.Control.getString("RTE.Mode."+c));this.Events.onpropertychange.fire([this,a])}},getModeKey:function RTE$getModeKey(b){var a=RTE.ModeStrings[b];if(!a)a=RTE.ModeStrings[RTE.Mode.RichText];return a},_rteSelection:false,_setToolbarEnabled:function RTE$_setToolbarEnabled(a){this._toolbar.forEach(function(d,b){var c=b.context;if(b.key!="showModes"&&b.key!="cut"&&b.key!="copy"&&b.key!="paste")c.setButtonProperty(b.key,"enabled",a)},this._toolbar)},_toolbar_onClick:function RTE$_toolbar_onClick(h){var k=h[0],a=h[1],b=this.rte.getSelection();if(this._toolbar.getButtonProperty(a.key,"enabled")&&this.rte.execCommand(b,a.key,a.data)){this._updateToolbar(b);return}var c=$tag(a.button,"A")[0];switch(a.key){case "showFgc":case "showBgc":this._showColorPallete(c,$CD(this,this._palleteOnClick),{cmd:a.key,range:b});break;case "showModes":var d=this.rte.elt.getAttribute("mode");this._showMenu(c,"_modeMenuElt",d,$CD(this,this.modeMenuOnClick),{key:a.key,range:b});break;case "showFontNames":var d=this.elt.getAttribute("fontname"),g=this._showMenu(c,"_fnMenuElt",d,$CD(this,this._fontMenuOnClick),{key:a.key,range:b});g.forEach(function(c,a){var b=$tag(g.getButtonProperty(a.key,"elt"),"a")[0];b.style.fontFamily=a.button.innerText});break;case "showFontSizes":var f=RTE.Editor.getFontSizes(),j=f.length,i=parseInt(this.elt.getAttribute("fontsize")+""),d=-1;for(var e=0;e<j;e++)if(i==parseInt(f[e]))d=e+1+"";var g=this._showMenu(c,"_fsMenuElt",d,$CD(this,this._fontMenuOnClick),{key:a.key,range:b});break;case "showCL":this._showCreateLink(c,$CD(this,this._createLinkOnClick),{cmd:"createlink",range:b})}},_cl:null,_clOnClick:null,_clOnDispose:null,_clElt:null,_showCreateLink:function RTE$_showCreateLink(a,b,d){this._createLinkDispose();this._cl=new Hyperlink(this._clElt,a);this._cl.userdata=d;this._clOnClick=b;this._cl.Events.oninsertlink.attach(this._clOnClick);this._clOnDispose=$CD(this,this._createLinkDispose);this._cl.Events.ondispose.attach(this._clOnDispose);var c={y:$getLocation(this._toolbar.elt).bottom-$getLocation(a).bottom};this._cl.show(c);this._cl.focus()},_createLinkOnClick:function RTE$_createLinkOnClick(c){var f=c[0],a=c[1];if(a.value.length==0)return;var b=f.userdata,e=encodeURI(a.value),d=RTE.Editor.HTMLEncode(a.value);if((Browser.isIE||Browser.isFF)&&""==b.range.text)this.rte.insertContent(String.format('<a href="{0}">{1}</a>',e,d));else this.rte.execCommand(b.range,b.cmd,a.value)},_createLinkDispose:function RTE$_createLinkDispose(){if(this._cl){this._cl.hide();this._cl=null}},_cp:null,_cpOnClick:null,_cpDispose:null,_cpElt:null,_showColorPallete:function RTE$_showColorPallete(a,b,d){this._disposePicker();this._cp=new ColorPicker(this._cpElt,a);this._cp.userdata=d;this._cpOnClick=b;this._cp.Events.onclick.attach(this._cpOnClick);this._cpDispose=$CD(this,this._disposePicker);this._cp.Events.ondispose.attach(this._cpDispose);var c={y:$getLocation(this._toolbar.elt).bottom-$getLocation(a).bottom};this._cp.show(c);this._cp.focus()},_palleteOnClick:function RTE$_palleteOnClick(b){var a=b[0],e=b[1],c=a.userdata.cmd=="showFgc"?"forecolor":RTE.Control._BACK_COLOR_CMD_ID,d=a.userdata.range;this.rte.execCommand(d,c,e.color)},_disposePicker:function RTE$_disposePicker(){if(this._cp){this._cp.hide();this._cp=null}},modeMenuOnClick:function RTE$modeMenuOnClick(c){var e=c[0],a=c[1],b=this.rte.getMode(),d=b!=RTE.Mode.PlainText&&RTE.Mode[a.key]==RTE.Mode.PlainText;if(d){setTimeout($CD(this,function(){if(confirm(RTE.Control.getString(b==RTE.Mode.RichText?"RTE.Toolbar.RichToPlainWarning":"RTE.Toolbar.HtmlToPlainWarning"))){this.rte.setMode(RTE.Mode[a.key]);this.rte.focus()}}),0);return}this.rte.setMode(RTE.Mode[a.key]);this.rte.focus()},_fontMenuOnClick:function RTE$_fontMenuOnClick(e){var c=e[0],g=e[1],b=c.userdata.key=="showFontNames"?"fontname":"fontsize",f=g.key,d=c.userdata.range;this.rte.execCommand(d,b,f);if(b=="fontsize"){var a=d.parentElement();if(a.tagName=="FONT"||a.tagName=="SPAN"){a.style.fontSize=a.size!=""?RTE_CONFIG.FONT_SIZE[a.size-1]:"";a.onpropertychange=function(){if(null==event||event.propertyName!="size")return;a.style.fontSize=a.size!=""?RTE_CONFIG.FONT_SIZE[a.size-1]:""}}}},_menu:null,_menuOnDispose:null,_menuOnClick:null,_showMenu:function RTE$_showMenu(b,c,a,d,f){this._disposeMenu();this._menu=new Menu(this[c],b);this._menu.userdata=f;this._menuOnClick=d;this._menu.Events.onbuttonclick.attach(this._menuOnClick);this._menuOnDispose=$CD(this,this._disposeMenu);this._menu.Events.ondispose.attach(this._menuOnDispose);this._menu.forEach(function(a,b){a.setButtonProperty(b.key,"selected",false)});if(a&&this._menu.containsButtonKey(a))this._menu.setButtonProperty(a,"selected",true);var e={x:Loc.isBidi?-1:1,y:$getLocation(this._toolbar.elt).bottom-$getLocation(b).bottom};this._menu.show(e);this._menu.focus();return this._menu},_disposeMenu:function RTE$_disposeMenu(){if(this._menu){var a=this._menu.elt;this._menu.Events.onbuttonclick.detach(this._menuOnClick);this._menu.Events.ondispose.detach(this._menuOnDispose);this._menuOnDispose=null;this._menuOnClick=null;this._menu.hide();this._menu=null}},_rte_onExecCommand:function RTE$_rte_onExecCommand(b){var c=b[0],a=b[1];this._updateButton(this._toolbar,{key:a.command,context:a.range,value:a.value,viaExecCmd:true})},_rte_onSelectionChange:function RTE$_rte_onSelectionChange(a){var c=a[0],b=a[1];this._updateToolbar(b.range)},_updateToolbar:function RTE$updateToolbar(a){if(this.rte.isRTEMode()){var b=this._toolbar,c=$CD(this,this._updateButton);b.forEach(c,a);c(b,{key:"fontname",context:a});c(b,{key:"fontsize",context:a});c(b,{key:"fontcolor",context:a});c(b,{key:RTE.Control._BACK_COLOR_CMD_ID,context:a})}},_updateButton:function RTE$_updateButton(f,a){var b=a.context;switch(a.key){case "bold":case "italic":case "underline":this._toolbar.setButtonProperty(a.key,"selected",this.rte.queryCommandState(b,a.key));break;case "fontsize":if(!a.viaExecCmd)this._updateFontSizeButton(b,a);else setTimeout($CD(this,function(){var b=RTE.Editor.getFontSizes();this._updateFontSizeButtonCaption(b[a.value-1])}),100);break;case "fontname":if(!a.viaExecCmd){var e=this._toolbar.getButtonProperty("showFontNames","text"),c=this.rte.queryCommandValue(b,a.key)||this._findEltWithStyle(b.parentElement(),"fontName").currentStyle.fontFamily.split(",")[0]||e;c=c.replace(/'/g,"");this._updateFontNameButton(c)}else this._updateFontNameButton(a.value);break;case RTE.Control._BACK_COLOR_CMD_ID:var d=this._parseColor(this.rte.queryCommandValue(b,a.key));this.elt.setAttribute("backcolor",String.format("{1}{2}{3}",a.key,d.red,d.green,d.blue))}},_updateFontSizeButton:function RTE$IE$_updateFontSizeButton(c){var a=this.rte.queryCommandValue(c,"fontsize")+"",b=RTE.Editor.getFontSizes();if(a.length==1)a=b[a-1];else if(a==""||a=="null"){var d=this._findEltWithStyle(c.parentElement(),"fontSize");a=d.style.fontSize||b[d.size-1]}this._updateFontSizeButtonCaption(a)},_updateFontSizeButtonCaption:function RTE$IE$_updateFontSizeButtonCaption(a){if(this.elt.getAttribute("fontsize")!=a){this._showSpan("showFontSizes",parseInt(a));this.elt.setAttribute("fontsize",a)}},_showSpan:function RTE$_showSpan(d,e){var f=this._toolbar.getButtonProperty(d,"elt"),a=$tag(f,"SPAN"),c=a.length-2;for(var b=a.length-2;b>=0;b--){$setDisplay(a[b],false);if(a[b].innerHTML==e)c=b}$setDisplay(a[c],true)},_updateFontNameButton:function RTE$IE$_updateFontNameButton(a){if(this.elt.getAttribute("fontname")!=a){this._showSpan("showFontNames",a);this.elt.setAttribute("fontname",a)}},_findEltWithStyle:function RTE$findEltWithStyle(a,b){while(a&&a!=this.rte._editor){if("fontSize"==b&&(a.style.fontSize||a.size))return a;if("fontName"==b&&a.style.fontFamily)return a;a=a.parentElement}return this.rte._editor},_parseColor:function RTE$IE$_parseColor(a){var c=~0>>>24,b=c<<8,d=b<<8;return {red:c&a,green:(b&a)>>8,blue:(d&a)>>16}},focus:function RTE$focus(){this.rte.focus()}};RTE.Control.getString=function RTE$Control$getString(a){return decodeURIComponent(RTE_STRINGS[a])};RTE.Control._BACK_COLOR_CMD_ID="backcolor";RTE.Control.createClass("RTE.Control");if(Browser.isSF){RTE.Control.prototype._parseColor=function RTE$SF_parseColor(b){var c=/rgb([a])?\(([^,]+),([^,]+),([^,\)]+)/,a=c.exec(b);if(a[1]=="a")a=[null,255,255,255];return {red:a[1],green:a[2],blue:a[3]}};RTE.Control.prototype._updateFontSizeButtonCaption=function RTE$SF$_updateFontSizeButtonCaption(a){if(this.elt.getAttribute("fontsize")!=a){this._toolbar.setButtonProperty("showFontSizes","text",parseInt(a));this.elt.setAttribute("fontsize",a)}};RTE.Control.prototype._updateFontNameButton=function RTE$SF$_updateFontNameButton(a){if(this.elt.getAttribute("fontname")!=a){this._toolbar.setButtonProperty("showFontNames","text",a);this.elt.setAttribute("fontname",a)}};RTE.Control.prototype._updateFontSizeButton=function RTE$SF$_updateFontSizeButton(d){var b=null;try{var a=d.parentElement();while(a&&a!=this.elt){if(a.tagName=="SPAN"&&a.className=="Apple-style-span"&&""!=a.style.fontSize){b=a.style.fontSize;break}a=a.parentNode}this._updateFontSizeButtonCaption(b?b:RTE_CONFIG.DEFAULT_FONT_SIZE)}catch(c){if(!(Browser.isSF3&&c.name=="WRONG_DOCUMENT_ERR"))throw c;}}}if(Browser.isFF){RTE.Control._BACK_COLOR_CMD_ID="hilitecolor";RTE.KeyCodes={B:98,I:105,U:117};RTE.Control.prototype._rte_onKeyPress=function RTE$IE$_rte_onKeyPress(a){if(!a.ctrlKey)return;var b=this.rte.getSelection();switch(a.charCode){case RTE.KeyCodes.B:this.rte.execCommand(b,"bold",null);a.returnValue=false;break;case RTE.KeyCodes.I:this.rte.execCommand(b,"italic",null);a.returnValue=false;break;case RTE.KeyCodes.U:this.rte.execCommand(b,"underline",null);a.returnValue=false}};RTE.Control.prototype._updateFontSizeButtonCaption=function RTE$FF$_updateFontSizeButtonCaption(a){if(this.elt.getAttribute("fontsize")!=a){this._toolbar.setButtonProperty("showFontSizes","text",parseInt(a)+"");this.elt.setAttribute("fontsize",a)}};RTE.Control.prototype._updateFontNameButton=function RTE$FF$_updateFontNameButton(a){if(this.elt.getAttribute("fontname")!=a){this._toolbar.setButtonProperty("showFontNames","text",a);this.elt.setAttribute("fontname",a)}};RTE.Control.prototype._parseColor=function RTE$FF$_parseColor(b){var c=/rgb\(([^,]+),([^,]+),([^,\)]+)/,a=c.exec(b)||[null,255,255,255];return {red:a[1],green:a[2],blue:a[3]}}}RTE.Control.createClass("RTE.Control");var ButtonList=function ButtonList(c){Control.create(this,c);this._buttons={};this._keys=[];this._data={};this._enabled=false;this.Events={onbuttonclick:new $Event,ondispose:new $Event};var b=$tag(c,"li"),f=b.length;for(var a=0;a<f;a++){if(b[a].className=="Divider")continue;var e=b[a].getAttribute("key");this.initializeButton(b[a],e)}var d=c.getAttribute("enabled")=="true";this.setEnabled(d)};ButtonList.prototype={elt:null,userdata:null,_buttons:null,_keys:null,_data:null,initializeButton:function ButtonList$initializeButton(b,a){this._keys.push(a);this._buttons[a]=b;this._data[a]=b.getAttribute("data")},_enabled:true,getEnabled:function ButtonList$getEnabled(){return this._enabled},setEnabled:function ButtonList$setEnabled(a){if(a==this._enabled)return;if(a)$replaceClass(this.elt,"Disabled","Enabled");else $replaceClass(this.elt,"Enabled","Disabled");this.elt.setAttribute("enabled",a.toString());this._enabled=a},forEach:function ButtonList$forEach(c,d){var e=this._keys.length;for(var a=0;a<e;a++){var b=this._keys[a];c(this,{button:this._buttons[b],idx:a,key:b,context:d})}},clear:function ButtonList$clear(){this._buttons={};this._keys=[];this._data={};var a=$tag(this.elt,"UL")[0];a.innerHTML=""},count:function ButtonList$count(){return this._keys.length},containsButtonKey:function ButtonList$containsButtonKey(a){return this._keys.exists(a)},getButtonProperty:function ButtonList$getButtonElt(b,c){var a=this._buttons[b];switch(c){case "elt":return a;case "enabled":return !$css.has(a,"Disabled");case "visible":return $getDisplay(a);case "text":return $tag(a,"SPAN")[0].innerText;case "selected":return $css.has(a,"Selected");case "html":return $tag(a,"SPAN")[0].innerHTML;case "data":return this._data[b]}},setButtonProperty:function ButtonList$setButtonProperty(c,d,b){var a=this._buttons[c];switch(d){case "enabled":if(b)$css.remove(a,"Disabled");else $css.add(a,"Disabled");break;case "selected":if(b)$css.add(a,"Selected");else $css.remove(a,"Selected");break;case "visible":$setDisplay(a,b);break;case "text":$tag(a,"SPAN")[0].innerText=b;break;case "html":$tag(a,"SPAN")[0].innerHTML=b;break;case "data":this._data[c]=b}},dispose:function ButtonList$dispose(){this.userdata=null;Control.destroy(this)},_buttonOnClick:function ButtonList$_buttonOnClick(a){if(!a)return;var b={button:Control.getAncestorByAttr(event.srcElement,"key"),key:a,data:this._data[a]};if(this._enabled&&this.getButtonProperty(a,"enabled"))this.Events.onbuttonclick.fire([this,b])}};ButtonList.prototype.addButton=function ButtonList$addButton(c){this._buttons={};this._keys=[];var d=$tag(this.elt,"UL")[0];d.innerHTML+=this.getButtonHTML(c);var b=$tag(d,"LI"),f=b.length;for(var a=0;a<f;a++){if(b[a].className=="Divider")continue;var e=b[a].getAttribute("key");this._keys.push(e);this._buttons[e]=b[a]}this._data[c.key]=c.data};ButtonList.createClass("ButtonList");var Menu=function Menu(b,a){ButtonList.call(this,b);this.Events={onbuttonclick:new $Event,ondispose:new $Event,onhidden:new $Event};this.setEnabled(true);this.owner=a;this._focusHandler=$CD(this,this._focusOut);this.elt.attachEvent("onfocusout",this._focusHandler);this._keyDownHandler=$CD(this,this._keyDown);this.elt.attachEvent("onkeydown",this._keyDownHandler);this.hide()};Menu.prototype={owner:null,_focusHandler:null,dispose:function Menu$dispose(){this.hide();if(this.owner!=null){this.Events.ondispose.fire([this]);this.elt.detachEvent("onfocusout",this._focusHandler);this.owner=null;this.callBase(ButtonList,"dispose")}},_keyDown:function Menu$keyDown(){this._lastKey=event.keyCode},_focusOut:function Menu$onFocusOut(){if(!this.elt.contains(event.toElement)&&this.elt!=event.toElement){if(this._lastKey==9&&this.owner&&this.owner.focus)$callFocus(this.owner);this.dispose()}},getButtonHTML:function Menu$getButtonHTML(a){return String.format(Menu._BUTTON_HTML,a.key,a.caption||"",a.tooltip||"")},focus:function Menu$focus(){if(this._keys.length>0){var a=null;this.forEach(function(c,b){if(!a&&c.getButtonProperty(b.key,"visible"))a=$tag(c.getButtonProperty(b.key,"elt"),"A")[0]});if(a)$callFocus(a)}},_selected:null,getSelectedButton:function Menu$getSelectedButton(){return this._selected},setSelectedButton:function Menu$setSelectedButton(a){if(this._selected)this.setButtonProperty(this._selected,"selected",false);if(a)this.setButtonProperty(a,"selected",true)},reposition:function Menu$reposition(a){AlignBehavior.DropDown(this.elt,this.owner,a)},show:function Menu$show(a){$setDisplay(this.elt,true);this.reposition(a)},hide:function Menu$hide(){if(this.elt!=null)$setDisplay(this.elt,false);this.Events.onhidden.fire([this])},_buttonOnClick:function Menu$_buttonOnClick(a){if(a){this.callBase(ButtonList,"_buttonOnClick",[a]);this.dispose()}},getButtonHTML:function ButtonList$getButtonHTML(a){return Menu.CreateButtonHTML(a)}};if(Browser.isIE6){var oldShow=Menu.prototype.show;Menu.prototype.show=function Menu$show(b){oldShow.call(this,b);var a=this;setTimeout(function(){var b=$tag(a.elt,"DIV");b[b.length-1].style.height=$tag(a.elt,"UL")[0].offsetHeight+"px"},0)}}Menu._BUTTON_HTML='<li key="{0}"><a unselectable=on href="javascript:;" onclick="event.returnValue=false;" title="{2}">{1}</a></li>';Menu._DIVIDIER_HTML='<li class="Divider"><div></div></li>';Menu.CreateButtonHTML=function Menu$CreateButtonHTML(a){if(a.caption=="-")return Menu._DIVIDIER_HTML;return String.format(Menu._BUTTON_HTML,a.key,a.caption||"",a.tooltip||a.caption||"")};Menu.CreateMenuHTML=function Menu$CreateMenuHTML(c){var b=['<div onclick="return Control.invoke(\'Menu\', \'_buttonOnClick\', event, Control.lookup(event.srcElement, \'key\'));" enabled="false" class="Menu t_hovl c_m Disabled" style="display: none;"><div class="MenuTop"><div class="MenuItems"><ul>'],d=c.length;for(var a=0;a<d;a++)b[a+1]=Menu.CreateButtonHTML(c[a]);b[d+1]='</ul></div></div><div class="shadow"></div></div>';return b.join("")};Menu.Create=function Menu$Create(b){var a=document.createElement("div");document.body.appendChild(a);a.innerHTML=Menu.CreateMenuHTML(b||[]);a=a.firstChild;return a};Menu.Destroy=function Menu$Destroy(a){if(a!=null&&a.parentElement!=null)document.body.removeChild(a.parentElement)};Menu.createClass("Menu",ButtonList);var AlignBehavior={};AlignBehavior.DropDown=function AlignBehavior$DropDown(c,g,i){var d=$getLocation(g,i),f=d.left;if(document.documentElement.dir=="rtl")f=d.right-c.offsetWidth;var a={x:f,y:d.bottom},b=a.x+c.offsetWidth-document.body.offsetWidth;a.x=b>0?a.x-b:a.x;if(document.documentElement.dir=="rtl")a.x=a.x<0?0:a.x;var h=a.x,e=0;if(Browser.isSF){b=a.y+c.offsetHeight-document.body.offsetHeight;e=(b>0?a.y-b:a.y)+document.body.scrollTop}else{b=a.y-document.getElementsByTagName("HTML")[0].scrollTop+c.offsetHeight-document.body.offsetHeight;e=b>0?a.y-b:a.y}c.style.left=h+"px";c.style.top=e+"px"};var ColorPicker=function ColorPicker(b,a){Control.create(this,b);this.owner=a;this.Events={ondispose:new $Event,onclick:new $Event};this._clickHandler=$CD(this,this._onClick);this.elt.attachEvent("onclick",this._clickHandler);this._focusHandler=$CD(this,this._focusOut);this.elt.attachEvent("onfocusout",this._focusHandler)};ColorPicker.prototype={owner:null,_focusHandler:null,_clickHandler:null,dispose:function ColorPicker$dispose(){if(this.elt!=null){this.Events.ondispose.fire([this]);this.elt.detachEvent("onclick",this._clickHandler);this.elt.detachEvent("onfocusout",this._focusHandler);Control.destroy(this);this.owner=null}},_focusOut:function Menu$onFocusOut(){if(!this.elt.contains(event.toElement)&&this.elt!=event.toElement)this.dispose()},_onClick:function ColorPicker$_onClick(){var a=event.srcElement;if(a.tagName!="A")return;if(a.className=="Swatch"){this.doAction("color",Browser.isFF?"#"+a.getAttribute("color"):a.style.backgroundColor);this.dispose()}else{this.doAction(a.getAttribute("cmd"),null);this.dispose()}},doAction:function ColorPicker$doAction(a,b){switch(a){case "color":this.Events.onclick.fire([this,{action:a,color:b}])}},focus:function ColorPicker$focus(){$callFocus($tag(this.elt,"A")[0])},hide:function ColorPicker$hide(){$setDisplay(this.elt,false)},show:function ColorPicker$show(a){$setDisplay(this.elt,true);setTimeout($CD(this,function(){AlignBehavior.DropDown(this.elt,this.owner,a);if(Browser.isIE6){var b=this;setTimeout(function(){var a=$tag(b.elt,"DIV");a[a.length-1].style.height=b.elt.firstChild.offsetHeight+"px"},10)}}),0)}};ColorPicker._COLOR_ROW="";ColorPicker.PRIMARY_PALLETE=["C00000","FF0000","FFC000","FFFF00","92D050","00B050","00B0F0","0070C0","002060","7030A0"],ColorPicker.SECONDARY_PALLETE=["FFFFFF","000000","EEECE1","1F497D","4F81BD","C0504D","9BBB59","8064A2","4BACC6","F79646"],ColorPicker.MIXED_PALLETE=[["F2F2F2","7F7F7F","DDD9C3","C6D9F0","DBE5F1","F2DCDB","EBF1DD","E5E0EC","DBEEF3","FDEADA"],["D8D8D8","595959","C4BD97","8DB3E2","B8CCE4","E5B9B7","D7E3BC","CCC1D9","B7DDE8","FBD5B5"],["BFBFBF","3F3F3F","938953","548DD4","95B3D7","D99694","C3D69B","B2A2C7","92CDDC","FAC08F"],["A5A5A5","262626","494429","17365D","366092","953734","76923C","5F497A","31859B","E36C09"],["808080","0C0C0C","1D1B10","0F243E","244061","632423","4F6128","3F3151","205867","974806"]];ColorPicker.Create=function ColorPicker$Create(){var b=document.createElement("div");document.body.appendChild(b);var c=[],h=ColorPicker.MIXED_PALLETE.length,d=Resize.convertToEm(7),f=Resize.convertToEm(25),g=Resize.convertToEm(100),e=Resize.convertToEm(108);for(var a=0;a<h;a++)c.push(ColorPicker._MakeRow(ColorPicker.MIXED_PALLETE[a],a+f));b.innerHTML=['<div class="ColorPicker" style="display:none"><div class="SwatchHolder">',ColorPicker._MakeRow(ColorPicker.SECONDARY_PALLETE,d),c.join(""),String.format('<div class="Divider" style="top:{0}em;" ></div>',g),ColorPicker._MakeRow(ColorPicker.PRIMARY_PALLETE,e),"</div>",'<div class="shadow"></div></div>'].join("");return b.firstChild};ColorPicker._PadLeft=function ColorPicker$_PadLeft(a){var b="000000";if(a.length<b.length)return b.substring(0,b.length-a.length)+a;return a};ColorPicker.Destroy=function ColorPicker$Destroy(a){if(a!=null&&a.parentElement!=null)document.body.removeChild(a.parentElement)};ColorPicker._MakeRow=function ColorPicker$_MakeRow(b,e){var c=[],d=b.length;for(var a=0;a<d;a++)c.push(String.format('<a href="#" class="Swatch" onclick="event.returnValue=false;" style="background-color:#{0};{3}:{1}em;top:{2}em;" color="{0}">&nbsp;</a>',b[a],a*1.25+.7,e,Loc.LEFT));return c.join("")};ColorPicker.createClass("ColorPicker");function Hyperlink(b,a){Control.create(this,b);this.Events={ondispose:new $Event,oninsertlink:new $Event};this.owner=a;this._input=$tag(this.elt,"input")[0];this._focusHandler=$CD(this,this._focusOut);this.elt.attachEvent("onfocusout",this._focusHandler)}Hyperlink.prototype={owner:null,_input:null,_focusOutHandler:null,_clickHandler:null,dispose:function Hyperlink$dispose(){if(this.elt!=null){this.elt.detachEvent("onfocusout",this._focusHandler);this.Events.ondispose.fire(this);Control.destroy(this)}},_focusOut:function Hyperlink$focusOut(){if(!this.elt.contains(event.toElement)&&this.elt!=event.toElement)this.dispose()},focus:function Hyperlink$focus(){$callFocus(this._input)},onClick:function Hyperlink$onClick(a){this.doAction(a,{value:this._input.value});this.dispose()},hide:function Hyperlink$hide(){$setDisplay(this.elt,false)},show:function Hyperlink$show(b){$setDisplay(this.elt,true);AlignBehavior.DropDown(this.elt,this.owner,b);if(Browser.isIE6){var a=this;setTimeout(function(){var b=$tag(a.elt,"DIV");b[b.length-1].style.height=a.elt.firstChild.offsetHeight+"px"},0)}},doAction:function Hyperlink$doAction(a,b){switch(a){case "ok":this.Events.oninsertlink.fire([this,{value:b.value}]);break;case "cancel":this.dispose()}}};Hyperlink.getString=function Hyperlink$getString(a){return decodeURIComponent(HLINK_STRINGS[a])};Hyperlink._HTML='<div class="Hyperlink" style="display:none"><div class="Content"><div><Label for="HLINK_URL">{0}</Label></div><div class="UrlContainer"><input type="text" name="HLINK_URL" class="Url" value="http://" /></div><div class="Buttons" onclick="return Control.invoke(\'Hyperlink\', \'onClick\', event, Control.lookup(event.srcElement, \'aid\'));"><input class="UiButton" value="{1}" type="button" aid="ok"/><input class="UiButton" type="button" aid="cancel" value="{2}" /></div></div><div class="shadow"></div></div>';Hyperlink.CreateHTML=function Hyperlink$CreateHTML(){return String.format(Hyperlink._HTML,Hyperlink.getString("RTE.InsertHyperlink.Caption"),Hyperlink.getString("RTE.InsertHyperlink.OK"),Hyperlink.getString("RTE.InsertHyperlink.Cancel"))};Hyperlink.Create=function Hyperlink$Create(b){var a=document.createElement("div");document.body.appendChild(a);a.innerHTML=Hyperlink.CreateHTML(b);return a.firstChild};Hyperlink.Destroy=function Hyperlink$Destroy(a){if(a!=null&&a.parentElement!=null)document.body.removeChild(a.parentElement)};Hyperlink.createClass("Hyperlink");ComposePage.initializeBucket1=function ComposePage$initializeBucket1(){window.setTimeout(function(){ComposePage.RTE=new RTE.Control($("RichTextEditor"));ComposePage.RTE.rte.Events.onrteready.attach(ComposePage._onRteReady)},10);window.setTimeout(function(){ComposePage.downloadBucket2()},20)};ComposePage.downloadBucket2=function ComposePage$downloadBucket2(){Loader.load(ComposePage.bucket2Css,ComposePage.bucket2Script,ComposePage.onBucket2Download,$("bucket2"))};ComposePage.onBucket2Download=function ComposePage$onBucket2Download(){ComposePage.initializeBucket2()};ComposePage._onRteReady=function ComposePage$_onRteReady(a){var b=a[0],c=a[1];ComposePage.RTE.rte.Events.onrteready.detach(ComposePage._onRteReady);ComposePage.initialState.rteValue=ComposePage.RTE.rte.getValue();ComposePage.RTE.Events.onpropertychange.attach(ComposePage._onRTEPropertyChange);if(ComposePage.kbdShortcuts)KeyboardHandler.attachToIframe(ComposePage.RTE.rte._iframe)};ComposePage._onRTEPropertyChange=function ComposePage$_onRTEPropertyChange(d){var b=d[0],a=d[1];if(a.property=="mode"){$tag($("rteMode"),"SPAN")[0].innerText=RTE.Control.getString("RTE.Mode."+b.getModeKey(a.to));$css.remove($("RTE"+b.getModeKey(a.from)),"sel");$css.add($("RTE"+b.getModeKey(a.to)),"sel");var c=$Cookie.getCookieValues(App.config.pdCookie);c["ptm"]=a.to==RTE.Mode.PlainText?"1":"0";$Cookie.setCookieValues(App.config.pdCookie,c,$Cookie.getPermanentExpirationDate());ComposeToolbar.updateToolbarState()}};if(!Browser.isIE)ComposePage.downloadBucket2=function ComposePage$downloadBucket2(){Loader.load(ComposePage.bucket2Css,ComposePage.bucket2Script,ComposePage.onBucket2Download)}